<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<head>
    <title>Panel de Compras | Terranova</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .card-hover {
            transition: all 0.4s ease;
        }
        .card-hover:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
        }
        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .status-en-proceso {
            background-color: #f59e0b;
        }
        .status-finalizada {
            background-color: #10b981;
        }
        .file-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 14px;
        }

        /* Gradientes profesionales */
        .floating-animation {
        animation: float 6s ease-in-out infinite;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .compra-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .section-card {
            background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
            border: 1px solid rgba(148, 163, 184, 0.15);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .accent-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .accent-blue {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .accent-red{
            background: linear-gradient(135deg, #ef4444 0%, #991b1b 100%);
        }

        .accent-yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
        }

        .text-gradient {
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .fondo-card {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

    </style>
</head>
<body class="bg-gray-50">

<div class=" min-h-screen">
    <!-- Changed navbar to buyer navbar -->
    <div th:replace="fragments/comprador/navbarComprador :: navbarComprador"></div>

    <div class="ml-64 flex flex-col min-h-screen">
        <main class="w-full mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Updated header for buyer's purchase panel -->
            <div class="mb-5 glass-effect rounded-xl shadow-lg p-4 border-l-4 border-green-500 flex items-center justify-between">
                <!-- Título principal -->
                <div class="flex items-center space-x-2">
                    <i class="fas fa-shopping-cart text-green-600 text-xl"></i>
                    <h1 class="text-2xl font-bold text-green-600">Panel de Compras</h1>
                </div>

                <!-- Indicador de total de compras -->
                <div class="bg-white rounded-lg px-4 py-2 shadow flex items-center space-x-2">
                    <i class="fas fa-list text-green-600"></i>
                    <span class="font-semibold text-gray-800 text-sm">
            Total Compras: <span th:text="${compras.size()}">0</span>
        </span>
                </div>
            </div>


            <!-- Updated purchase list for buyer perspective -->
            <div class="space-y-4">
                <div th:each="compra : ${compras}">
                    <div class="card-hover compra-card rounded-xl shadow-lg overflow-hidden">
                        <!-- Header compacto -->
                        <div class="px-6 py-3 fondo-card border-gray-100">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center shadow-md">
                                        <div th:if="${compra.producto instanceof T(com.proyecto.terranova.entity.Ganado)}"><i class="fas fa-cow text-green-600 text-sm"></i></div>
                                        <div th:if="${compra.producto instanceof T(com.proyecto.terranova.entity.Terreno)}"><i class="fas fa-mountain text-green-600 text-sm"></i></div>
                                        <div th:if="${compra.producto instanceof T(com.proyecto.terranova.entity.Finca)}"><i class="fas fa-house text-green-600 text-sm"></i></div>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-white" th:text="${compra.producto.nombreProducto}">NombreProducto</h3>
                                        <p class="text-xs text-white" th:text="'ID: ' + ${compra.idVenta} + ' • ' + 'Iniciado el ' + ${compra.fechaInicioVenta}"></p>
                                    </div>
                                </div>
                                <div class="flex items-center bg-white px-3 py-1 rounded-full shadow-sm">
                                    <div th:switch="${compra.estado}">
                                        <span th:case="'Finalizada'" class="status-dot status-finalizada"></span>
                                        <span th:case="'Cancelada'" class="status-dot bg-red-500"></span>
                                        <span th:case="'En Proceso'" class="status-dot status-en-proceso"></span>
                                        <span th:case="'Pendiente Confirmacion'" class="status-dot bg-blue-500"></span>
                                    </div>
                                    <span class="text-xs font-semibold text-gray-700" th:text="${compra.estado}"></span>
                                </div>
                            </div>
                        </div>

                        <div class="p-5">
                            <!-- Layout Principal: Single Column with Horizontal Sections -->
                            <div th:classappend="${compra.estado == 'En Proceso' or compra.estado == 'Pendiente Confirmacion' ? 'opacity-100' : 'opacity-75'}" class="space-y-4">

                                <!-- FILA SUPERIOR: Producto y Vendedor lado a lado -->
                                <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                                    <!-- Producto -->
                                    <div class="section-card rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                            <div class="w-6 h-6 accent-green rounded-md flex items-center justify-center mr-2">
                                                <i class="fas fa-box text-white text-xs"></i>
                                            </div>
                                            Producto
                                        </h4>
                                        <div class="space-y-2">
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Tipo:</span>
                                                <span class="font-medium text-gray-800 text-sm" th:if="${compra.producto instanceof T(com.proyecto.terranova.entity.Ganado)}">Ganado</span>
                                                <span class="font-medium text-gray-800 text-sm" th:if="${compra.producto instanceof T(com.proyecto.terranova.entity.Terreno)}">Terreno</span>
                                                <span class="font-medium text-gray-800 text-sm" th:if="${compra.producto instanceof T(com.proyecto.terranova.entity.Finca)}">Finca</span>
                                            </div>
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Ubicación:</span>
                                                <span class="font-medium text-gray-800 text-sm" th:text="${compra.producto.ciudad.nombreCiudad}"></span>
                                            </div>
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Fecha De Publicacion:</span>
                                                <span class="font-medium text-gray-800 text-sm" th:text="${#strings.capitalize(#temporals.format(compra.producto.fechaPublicacion, 'EEEE d MMMM', T(java.util.Locale).forLanguageTag('es-ES')))}"></span>
                                            </div>
                                            <div class="flex justify-between py-1">
                                                <span class="text-gray-600 text-sm">Detalle del producto: </span>
                                                <span class="font-medium text-blue-600 underline text-sm"><a href="">Ver detalles completos</a></span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Vendedor -->
                                    <div class="section-card rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                            <div class="w-6 h-6 accent-green rounded-md flex items-center justify-center mr-2">
                                                <i class="fas fa-user-tie text-white text-xs"></i>
                                            </div>
                                            Vendedor
                                        </h4>
                                        <div class="space-y-2">
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Nombres:</span>
                                                <span class="font-medium text-gray-800 text-sm" th:text="${compra.producto.vendedor.nombres}"></span>
                                            </div>
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Apellidos:</span>
                                                <span class="font-medium text-gray-800 text-sm" th:text="${compra.producto.vendedor.apellidos}"></span>
                                            </div>
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Teléfono:</span>
                                                <span class="font-medium text-gray-800 text-sm" th:text="'+57 ' + ${compra.producto.vendedor.telefono}"></span>
                                            </div>
                                            <div class="flex justify-between py-1">
                                                <span class="text-gray-600 text-sm">Email:</span>
                                                <span class="font-medium text-gray-800 text-xs" th:text="${compra.producto.vendedor.email}"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- FILA INFERIOR: Compra y Comprobantes lado a lado -->
                                <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
                                    <!-- Compra -->
                                    <div class="section-card rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                            <div class="w-6 h-6 accent-yellow rounded-md flex items-center justify-center mr-2">
                                                <i class="fas fa-dollar-sign text-white text-xs"></i>
                                            </div>
                                            Compra
                                        </h4>
                                        <div class="space-y-2">
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Precio:</span>
                                                <span class="font-bold text-green-700" th:text="'$' + ${#numbers.formatInteger(compra.producto.precioProducto, 0, 'COMMA')}"></span>
                                            </div>
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Estado:</span>
                                                <span class="font-medium text-yellow-600 text-sm" th:text="${compra.estado}"></span>
                                            </div>
                                            <div class="flex justify-between py-1 border-b border-gray-100">
                                                <span class="text-gray-600 text-sm">Fecha:</span>
                                                <span class="font-medium text-gray-800 text-sm">
                                                    <span th:if="${compra.fechaVenta != null and compra.fechaVenta != ''}" th:text="${#strings.capitalize(#temporals.format(compra.fechaVenta, 'EEEE d MMMM - h:mm a', T(java.util.Locale).forLanguageTag('es-ES')))}"></span>
                                                    <span th:unless="${compra.fechaVenta != null and compra.fechaVenta != ''}">Aún no se ha finalizado la compra</span>
                                                </span>
                                            </div>
                                            <div class="flex justify-between py-1">
                                                <span class="text-gray-600 text-sm">Metodo De Pago:</span>
                                                <span class="font-medium text-gray-800 text-sm">
                                                    <span th:if="${compra.metodoPago != null and compra.metodoPago != ''}" th:text="${compra.metodoPago}"></span>
                                                    <span th:unless="${compra.metodoPago != null and compra.metodoPago != ''}">Aún no se ha finalizado la compra</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Comprobantes -->
                                    <div class="section-card rounded-lg p-4">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                            <div class="w-6 h-6 bg-gradient-to-r from-purple-500 to-purple-600 rounded-md flex items-center justify-center mr-2">
                                                <i class="fas fa-paperclip text-white text-xs"></i>
                                            </div>
                                            <div th:text="'Comprobantes (' + ${compra.listaComprobantes.size()} + ')'"></div>
                                        </h4>
                                        <div class="space-y-2">
                                            <div th:if="${not #lists.isEmpty(compra.listaComprobantes)}">
                                                <div th:each="comprobante : ${compra.listaComprobantes}">
                                                    <a th:href="@{'/archivos/' + ${comprobante.rutaArchivo}}" target="_blank" class="hover:bg-gray-200 cursor-pointer">
                                                        <div class="flex items-center space-x-3 p-2 bg-gradient-to-r from-gray-50 to-gray-100 rounded border border-gray-200">
                                                            <div class="file-icon bg-red-100 text-red-600">
                                                                <i class="fas fa-file-pdf"></i>
                                                            </div>
                                                            <div class="flex-1">
                                                                <p class="font-medium text-gray-800 text-sm" th:text="${comprobante.nombreComprobante}"></p>
                                                            </div>
                                                        </div>
                                                    </a>
                                                </div>
                                            </div>
                                            <div th:unless="${not #lists.isEmpty(compra.listaComprobantes)}">
                                                <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                                                    <div class="flex">
                                                        <div class="flex-shrink-0">
                                                            <i class="fas fa-info-circle text-blue-400 text-lg"></i>
                                                        </div>
                                                        <div class="ml-3">
                                                            <p class="text-sm text-blue-700 leading-relaxed">
                                                                El vendedor aún no ha subido comprobantes para esta venta.
                                                            </p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Updated action buttons for buyer perspective -->
                            <div th:switch="${compra.estado}">
                                <!-- Caso: Finalizada -->
                                <div th:case="'Finalizada'" class="mt-4 bg-green-50 border-l-4 border-green-400 p-3 rounded">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-check text-green-400"></i>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-green-700">
                                                Tu compra ha sido finalizada con éxito.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Caso: Cancelada -->
                                <div th:case="'Cancelada'" class="mt-4 bg-red-50 border-l-4 border-red-400 p-3 rounded">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-times text-red-400"></i>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-red-700">
                                                Esta compra ha sido cancelada.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Caso: En proceso -->
                                <div th:case="'En Proceso'" class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-3 rounded">
                                    <div class="flex">
                                        <div class="flex-shrink-0">
                                            <i class="fas fa-clock text-yellow-400"></i>
                                        </div>
                                        <div class="ml-3">
                                            <p class="text-sm text-yellow-700">
                                                Tu compra está en proceso. El vendedor está preparando la documentación.
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Caso: Pendiente Confirmación - Botones de acción -->
                                <div th:case="'Pendiente Confirmacion'">
                                    <div class="mt-4 bg-blue-50 border-l-4 border-blue-400 p-3 rounded mb-4">
                                        <div class="flex">
                                            <div class="flex-shrink-0">
                                                <i class="fas fa-info-circle text-blue-400"></i>
                                            </div>
                                            <div class="ml-3">
                                                <p class="text-sm text-blue-700">
                                                    El vendedor ha solicitado finalizar la venta. Revisa los detalles y confirma si deseas proceder.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                                        <form th:action="@{/comprador/compra/cancelar-venta}" method="post" class="inline">
                                            <input type="hidden" name="idVenta" th:value="${compra.idVenta}">
                                            <button type="submit" class="px-4 py-2 accent-red hover:from-red-600 hover:to-red-700 text-white rounded-lg font-medium transition-all duration-200 flex items-center shadow-md text-sm">
                                                <i class="fas fa-times mr-1"></i> Cancelar Venta
                                            </button>
                                        </form>

                                        <form th:action="@{/comprador/compra/finalizar-venta}" method="post" class="inline">
                                            <input type="hidden" name="idVenta" th:value="${compra.idVenta}">
                                            <button type="submit" class="px-4 py-2 accent-green hover:from-green-600 hover:to-green-700 text-white rounded-lg font-medium transition-all duration-200 flex items-center shadow-md text-sm">
                                                <i class="fas fa-check-circle mr-1"></i> Finalizar Venta
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Updated modals for buyer actions -->
<div id="modalConfirmacionVenta"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div id="modalContentConfirmacionVenta"
         class="bg-white rounded-2xl shadow-xl p-10 transform scale-75 opacity-0 transition duration-300 ease-out">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Confirmar Finalización</h2>
        <p class="text-gray-600 mb-6">
            ¿Estás seguro de que deseas finalizar esta compra? Esta acción no se puede deshacer.
        </p>
        <div class="flex justify-end space-x-3">
            <button onclick="cerrarModalConfirmacionVenta()"
                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold rounded-lg">
                Cancelar
            </button>
            <button onclick="confirmarFinalizacionVenta()"
                    class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg">
                Confirmar
            </button>
        </div>
    </div>
</div>

<div id="modalCancelacionVenta"
     class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div id="modalContentCancelacionVenta"
         class="bg-white rounded-2xl shadow-xl p-10 transform scale-75 opacity-0 transition duration-300 ease-out">
        <h2 class="text-xl font-bold text-red-600 mb-4">Cancelar Venta</h2>
        <p class="text-gray-600 mb-6">
            ¿Estás seguro de que deseas cancelar esta compra? Esta acción no se puede deshacer.
        </p>
        <div class="flex justify-end space-x-3">
            <button onclick="cerrarModalCancelacionVenta()"
                    class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold rounded-lg">
                No, mantener
            </button>
            <button onclick="confirmarCancelacionVenta()"
                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg">
                Sí, cancelar
            </button>
        </div>
    </div>
</div>

<script>
    function cerrarModalConfirmacionVenta() {
        const modal = document.getElementById('modalConfirmacionVenta');
        const modalContent = document.getElementById('modalContentConfirmacionVenta');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-75', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function cerrarModalCancelacionVenta() {
        const modal = document.getElementById('modalCancelacionVenta');
        const modalContent = document.getElementById('modalContentCancelacionVenta');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-75', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    }

    function confirmarFinalizacionVenta() {
        // Aquí iría la lógica para finalizar la venta
        cerrarModalConfirmacionVenta();
    }

    function confirmarCancelacionVenta() {
        // Aquí iría la lógica para cancelar la venta
        cerrarModalCancelacionVenta();
    }

    //LO DEL USER DROPDOWN
    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        const arrow = document.getElementById('dropdownArrow');

        if (dropdown.classList.contains('opacity-0')) {
            dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.add('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const userButton = event.target.closest('[onclick="toggleUserDropdown()"]');

        if (!userButton && !dropdown.contains(event.target)) {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            document.getElementById('dropdownArrow').style.transform = 'rotate(0deg)';
        }
    });
</script>
</body>
</html>
