<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil - Terranova</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#388e3c',
                        'secondary': '#ffcf00',
                        'primary-dark': '#2d5a2f',
                        'secondary-dark': '#b8860b'
                    }
                }
            }
        }
    </script>
    <style>
        .floating-animation {
        animation: float 6s ease-in-out infinite;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }
        .gradient-hero {
            background: linear-gradient(135deg, #064e3b 0%, #059669 50%, #10b981 100%);
        }
    </style>
</head>
<body class="bg-gray-50">
<div th:if="${lugar.equals('comprador')}">
    <div th:replace="fragments/comprador/navbarComprador :: navbarComprador"></div>
</div>
<div th:if="${lugar.equals('vendedor')}">
    <div th:replace="fragments/vendedor/navbarVendedor :: navbarVendedor"></div>
</div>

<div class="ml-64 flex flex-col min-h-screen">
    <main class="py-10 px-8">

        <div class="gradient-hero rounded-3xl p-8 mb-8 text-white flex justify-between items-center relative overflow-hidden">
            <div class="absolute inset-0 bg-black/10"></div>
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full"></div>
            <div class="absolute -bottom-5 -left-5 w-32 h-32 bg-white/5 rounded-full"></div>

            <div class="relative z-10 text-left max-w-xl">
                <h1 class="text-4xl font-bold mb-2">Mi Perfil</h1>
                <p class="text-emerald-100 text-lg">Gestiona tu información personal y configuración de cuenta</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">

            <div class="lg:col-span-3">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Foto de Perfil</h2>
                    <form id="photoForm" th:action="@{/usuarios/mi-perfil/cambiar-foto}" method="post" enctype="multipart/form-data">
                        <div class="flex flex-col items-center">
                            <div class="relative mb-4">
                                <div class="w-32 h-32 bg-primary rounded-full flex items-center justify-center overflow-hidden">
                                    <img id="profileImage" th:if="${usuario.foto != null}" th:src="@{'/imagenes/' + ${usuario.foto}}" alt="Foto de perfil" class="w-full h-full object-cover">
                                    <svg id="defaultAvatar" class="w-16 h-16 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                    </svg>

                                </div>
                            </div>

                            <input type="file" id="photoUpload" name="foto" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                            <button type="button" onclick="document.getElementById('photoUpload').click()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                                Cambiar Foto
                            </button>
                            <p class="text-xs text-gray-500 mt-2 text-center">JPG, PNG o GIF. Máximo 5MB.</p>
                        </div>
                    </form>
                </div>

                <div th:if="${!esVendedor}" class="bg-gradient-to-br from-primary to-primary-dark rounded-2xl shadow-sm p-6 mt-6 text-white">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">¿Quieres vender?</h3>
                        <p class="text-white/90 text-sm mb-4">Conviértete en vendedor y publica tus propiedades, ganado y terrenos</p>
                        <form th:action="@{/comprador/mi-perfil/ser-vendedor}" method="post">
                            <button type="submit" class="bg-secondary hover:bg-secondary-dark text-gray-800 font-semibold px-4 py-2 rounded-lg transition-colors w-full">
                                Ser Vendedor
                            </button>
                        </form>
                    </div>
                </div>

                <div th:if="${esVendedor}" class="bg-gradient-to-br from-primary to-primary-dark rounded-2xl shadow-sm p-6 mt-6 text-white">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-3">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9l1-4h16l1 4M4 9v10a2 2 0 002 2h12a2 2 0 002-2V9M9 22V12h6v10"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold mb-2">¡Ya eres vendedor!</h3>
                        <p class="text-white/90 text-sm mb-4">
                            Administra tus publicaciones y controla tu actividad desde el Panel Vendedor
                        </p>
                        <a th:href="@{/vendedor/dashboard}"
                           class="bg-secondary hover:bg-secondary-dark text-gray-800 font-semibold px-4 py-2 rounded-lg transition-colors w-full inline-block text-center">
                            Ir al Panel Vendedor
                        </a>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-6">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-semibold text-gray-900">Información Personal</h2>
                        <button id="editButton" onclick="toggleEdit()" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors text-sm font-medium">
                            Editar
                        </button>
                    </div>

                    <form th:action="@{/usuarios/mi-perfil/editar}" method="post" th:object="${usuario}" id="profileForm" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="nombres" class="block text-sm font-medium text-gray-700 mb-2">Nombres</label>
                                <input type="text" id="nombres" th:field="*{nombres}" maxlength="45" disabled
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-gray-50 disabled:text-gray-500">
                            </div>

                            <div>
                                <label for="apellidos" class="block text-sm font-medium text-gray-700 mb-2">Apellidos</label>
                                <input type="text" id="apellidos" th:field="*{apellidos}" maxlength="45" disabled
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-gray-50 disabled:text-gray-500">
                            </div>
                        </div>

                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico</label>
                            <input type="email" id="email" th:field="*{email}" disabled
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-gray-50 disabled:text-gray-500">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="telefono" class="block text-sm font-medium text-gray-700 mb-2">Teléfono</label>
                                <input type="tel" id="telefono" th:field="*{telefono}" maxlength="10" disabled
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-gray-50 disabled:text-gray-500">
                            </div>

                            <div>
                                <label for="nacimiento" class="block text-sm font-medium text-gray-700 mb-2">Fecha de Nacimiento</label>
                                <input type="date" id="nacimiento" th:field="*{nacimiento}" disabled
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent disabled:bg-gray-50 disabled:text-gray-500">
                            </div>
                        </div>

                        <div class="bg-gray-50 rounded-lg p-4">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Información de Cuenta</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
                                <div>
                                    <span class="font-medium">Fecha de Registro:</span>
                                    <span class="ml-2" th:text="${fechaRegistro}"></span>
                                </div>
                                <div>
                                    <span class="font-medium">Tipo de Usuario:</span>
                                    <span class="ml-2 bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs" th:each="rol : ${usuario.roles}" th:text="${rol.nombreRol}"></span>
                                </div>
                            </div>
                        </div>

                        <div id="actionButtons" class="flex justify-end space-x-3 hidden">
                            <button type="button" onclick="cancelEdit()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg transition-colors font-medium">
                                Cancelar
                            </button>
                            <button type="submit" class="bg-primary hover:bg-primary-dark text-white px-4 py-2 rounded-lg transition-colors font-medium">
                                Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mt-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Seguridad</h2>

                    <div class="space-y-4">
                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div>
                                <h3 class="font-medium text-gray-900">Contraseña</h3>
                                <p class="text-sm text-gray-600">Última actualización: hace 3 meses</p>
                            </div>
                            <button class="text-primary hover:text-primary-dark font-medium text-sm">
                                Cambiar
                            </button>
                        </div>

                        <div class="flex justify-between items-center py-3">
                            <div>
                                <h3 class="font-medium text-gray-900">Autenticación de dos factores</h3>
                                <p class="text-sm text-gray-600">Agrega una capa extra de seguridad</p>
                            </div>
                            <button class="text-primary hover:text-primary-dark font-medium text-sm">
                                Configurar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mt-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Configuración de Notificaciones</h2>

                    <form th:action="@{/usuarios/mi-perfil/notificaciones}" method="post" class="space-y-4">

                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div>
                                <h3 class="font-medium text-gray-900">Notificaciones por Email</h3>
                                <p class="text-sm text-gray-600">Recibe un correo cuando haya actividad importante</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="emailNotif" th:checked="${usuario.recibirCorreos}" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-primary transition"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition peer-checked:translate-x-full"></div>
                            </label>
                        </div>

                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div>
                                <h3 class="font-medium text-gray-900" th:text="${esVendedor} ? 'Ventas' : 'Compras'"></h3>
                                <p class="text-sm text-gray-600">Alertas sobre tus <span th:text="${esVendedor} ? 'ventas' : 'compras'"></span></p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="ventasCompras" th:checked="${usuario.notificacionesVentas}" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-primary transition"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition peer-checked:translate-x-full"></div>
                            </label>
                        </div>

                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div>
                                <h3 class="font-medium text-gray-900">Citas</h3>
                                <p class="text-sm text-gray-600">Notificaciones sobre confirmaciones y recordatorios de citas</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="citas" th:checked="${usuario.notificacionesCitas}" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-primary transition"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition peer-checked:translate-x-full"></div>
                            </label>
                        </div>

                        <div th:if="${esVendedor}" class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div>
                                <h3 class="font-medium text-gray-900">Disponibilidades</h3>
                                <p class="text-sm text-gray-600">Cuando un comprador reserva o interactúa con tus horarios</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="disponibilidades" th:checked="${usuario.notificacionesDisponibilidades}" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-primary transition"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition peer-checked:translate-x-full"></div>
                            </label>
                        </div>

                        <div class="flex justify-between items-center py-3 border-b border-gray-100">
                            <div>
                                <h3 class="font-medium text-gray-900">Sistema</h3>
                                <p class="text-sm text-gray-600">Avisos importantes de la plataforma y de cambios en tu perfil</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="sistema" th:checked="${usuario.notificacionesSistema}" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-primary transition"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition peer-checked:translate-x-full"></div>
                            </label>
                        </div>

                        <div th:if="${esVendedor}" class="flex justify-between items-center py-3">
                            <div>
                                <h3 class="font-medium text-gray-900">Productos</h3>
                                <p class="text-sm text-gray-600">Novedades y estado de tus publicaciones</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="productos" th:checked="${usuario.notificacionesProductos}" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-primary transition"></div>
                                <div class="absolute left-0.5 top-0.5 bg-white w-5 h-5 rounded-full transition peer-checked:translate-x-full"></div>
                            </label>
                        </div>

                        <div class="flex justify-end pt-4">
                            <button type="submit" class="gradient-bg text-white px-6 py-2 rounded-lg font-medium hover:opacity-90 transition">
                                Guardar Preferencias
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div th:if="${vendedorExitoso}" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="vendorConfirmationModal">
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">

                <div class="w-20 h-20 bg-gradient-to-r from-[#388e3c] to-[#4caf50] rounded-full flex items-center justify-center mx-auto mb-6">
                    <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>

                <h2 class="text-2xl font-bold text-gray-800 mb-4">¡Felicidades! 🎉</h2>
                <p class="text-gray-600 mb-6 leading-relaxed">
                    Ya eres vendedor en nuestra plataforma. Ahora puedes acceder a tu panel principal como vendedor desde la opción
                    <span class="font-semibold text-[#388e3c]">"Panel Vendedor"</span> en el menú desplegable.
                </p>

                <div class="flex flex-col sm:flex-row gap-3">
                    <a th:href="@{/vendedor/dashboard}"><button class="flex-1 bg-[#388e3c] text-white px-6 py-3 rounded-xl font-medium hover:bg-[#2e7d32] transition-colors">
                        Ir al Panel Vendedor
                    </button></a>
                    <button class="flex-1 border border-gray-300 text-gray-700 px-6 py-3 rounded-xl font-medium hover:bg-gray-50 transition-colors" onclick="closeVendorModal()">
                        Continuar como Comprador
                    </button>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    let isEditing = false;
    let originalValues = {};

    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        const arrow = document.getElementById('dropdownArrow');

        if (dropdown.classList.contains('opacity-0')) {
            dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.add('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    function toggleEdit() {
        const form = document.getElementById('profileForm');
        const editButton = document.getElementById('editButton');
        const actionButtons = document.getElementById('actionButtons');
        const inputs = form.querySelectorAll('input:not([type="file"])');

        if (!isEditing) {
            // Guardar valores originales
            inputs.forEach(input => {
                originalValues[input.name] = input.value;
            });

            // Habilitar edición
            inputs.forEach(input => {
                if (input.name !== 'email') { // Email no editable por seguridad
                    input.disabled = false;
                    input.classList.remove('disabled:bg-gray-50', 'disabled:text-gray-500');
                }
            });

            editButton.textContent = 'Cancelar';
            editButton.classList.remove('bg-primary', 'hover:bg-primary-dark');
            editButton.classList.add('bg-gray-500', 'hover:bg-gray-600');
            actionButtons.classList.remove('hidden');
            isEditing = true;
        } else {
            cancelEdit();
        }
    }

    function cancelEdit() {
        const form = document.getElementById('profileForm');
        const editButton = document.getElementById('editButton');
        const actionButtons = document.getElementById('actionButtons');
        const inputs = form.querySelectorAll('input:not([type="file"])');

        // Restaurar valores originales
        inputs.forEach(input => {
            if (originalValues[input.name]) {
                input.value = originalValues[input.name];
            }
            input.disabled = true;
            input.classList.add('disabled:bg-gray-50', 'disabled:text-gray-500');
        });

        editButton.textContent = 'Editar';
        editButton.classList.remove('bg-gray-500', 'hover:bg-gray-600');
        editButton.classList.add('bg-primary', 'hover:bg-primary-dark');
        actionButtons.classList.add('hidden');
        isEditing = false;
    }

    function handlePhotoUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const profileImage = document.getElementById('profileImage');
                const defaultAvatar = document.getElementById('defaultAvatar');

                profileImage.src = e.target.result;
                profileImage.classList.remove('hidden');
                defaultAvatar.classList.add('hidden');
            };
            reader.readAsDataURL(file);

            document.getElementById('photoForm').submit();
        }
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const userButton = event.target.closest('[onclick="toggleUserDropdown()"]');

        if (!userButton && !dropdown.contains(event.target)) {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            document.getElementById('dropdownArrow').style.transform = 'rotate(0deg)';
        }
    });

    function closeVendorModal() {
            document.getElementById('vendorConfirmationModal').style.display = 'none';
        }
</script>
</body>
</html>
