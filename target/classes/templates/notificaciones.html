<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notificaciones - Panel Usuario</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .gradient-hero {
            background: linear-gradient(135deg, #064e3b 0%, #059669 50%, #10b981 100%);
        }

        .notification-producto {
            border-left: 4px solid #3b82f6;
            background: linear-gradient(90deg, #eff6ff 0%, #ffffff 100%);
        }
        .notification-venta {
            border-left: 4px solid #10b981;
            background: linear-gradient(90deg, #ecfdf5 0%, #ffffff 100%);
        }
        .notification-cita {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(90deg, #fffbeb 0%, #ffffff 100%);
        }
        .notification-sistema {
            border-left: 4px solid #8b5cf6;
            background: linear-gradient(90deg, #f3f4f6 0%, #ffffff 100%);
        }

        .notification-unread {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .badge-new {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .filter-active {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">

<div th:if="${lugar.equals('comprador')}">
    <div th:replace="fragments/comprador/navbarComprador :: navbarComprador"></div>
</div>
<div th:if="${lugar.equals('vendedor')}">
    <div th:replace="fragments/vendedor/navbarVendedor :: navbarVendedor"></div>
</div>

<div class="ml-64 flex flex-col min-h-screen">
    <main class="py-10 px-8">

        <!-- HEADER -->
        <div class="gradient-hero rounded-3xl p-8 mb-8 text-white flex justify-between items-center relative overflow-hidden">
            <!-- Fondo decorativo -->
            <div class="absolute inset-0 bg-black/10"></div>
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full"></div>
            <div class="absolute -bottom-5 -left-5 w-32 h-32 bg-white/5 rounded-full"></div>

            <div class="relative z-10 text-left max-w-xl">
                <h1 class="text-4xl font-bold mb-2">Notificaciones</h1>
                <p class="text-emerald-100 text-lg">Mantente al día con tus interacciones</p>
            </div>

            <a th:href="@{/api/reportes/ventas/{nombre}(nombre=${nombres})}" class="relative z-10">
                <button
                        class="bg-white/25 text-white border border-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-emerald-800 hover:border-emerald-600 transition transform duration-200 flex items-center gap-2">
                    <i class="bx bx-check-double"></i>
                    Marcar Todas Leidas
                </button>
            </a>
        </div>

        <!-- FILTROS -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <h3 class="font-semibold text-gray-800 mb-4">Filtrar por tipo</h3>
            <div class="flex gap-3 flex-wrap">
                <a th:href="@{/notificaciones(filtro='todas')}"
                   th:classappend="${filtro=='todas'} ? 'filter-active' : 'border border-gray-300 text-gray-700'"
                   class="filter-btn border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200 px-4 py-2 rounded-lg font-medium">Todas (<span th:text="${notificaciones.size()}"></span>)</a>

                <a th:if="${esVendedor}" th:href="@{/notificaciones(filtro='producto')}"
                   th:classappend="${filtro=='producto'} ? 'filter-active' : 'border border-gray-300 text-gray-700'"
                   class="filter-btn border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200 px-4 py-2 rounded-lg font-medium">
                    <i class="bx bx-package text-blue-500"></i> Productos (<span th:text="${totalProducto}"></span>)
                </a>

                <a th:href="@{/notificaciones(filtro='venta')}"
                   th:classappend="${filtro=='venta'} ? 'filter-active' : 'border border-gray-300 text-gray-700'"
                   class="filter-btn border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200 px-4 py-2 rounded-lg font-medium">
                    <i class="bx bx-dollar text-green-500"></i> Compras/Ventas (<span th:text="${totalVenta}"></span>)
                </a>

                <a th:href="@{/notificaciones(filtro='cita')}"
                   th:classappend="${filtro=='cita'} ? 'filter-active' : 'border border-gray-300 text-gray-700'"
                   class="filter-btn border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200 px-4 py-2 rounded-lg font-medium">
                    <i class="bx bx-calendar text-amber-500"></i> Citas (<span th:text="${totalCita}"></span>)
                </a>

                <a th:if="${esVendedor}" th:href="@{/notificaciones(filtro='disponibilidad')}"
                   th:classappend="${filtro=='cita'} ? 'filter-active' : 'border border-gray-300 text-gray-700'"
                   class="filter-btn border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200 px-4 py-2 rounded-lg font-medium">
                    <i class="bx bx-calendar text-blue-500"></i> Disponibilidades (<span th:text="${totalDisponibilidades}"></span>)
                </a>

                <a th:href="@{/notificaciones(filtro='sistema')}"
                   th:classappend="${filtro=='sistema'} ? 'filter-active' : 'border border-gray-300 text-gray-700'"
                   class="filter-btn border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-50 transition-all duration-200 px-4 py-2 rounded-lg font-medium">
                    <i class="bx bx-cog text-purple-500"></i> Sistema (<span th:text="${totalSistema}"></span>)
                </a>
            </div>
        </div>

        <!-- LISTA -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200">
            <div class="p-6 border-b border-gray-200 flex justify-between">
                <h3 class="text-lg font-semibold">Mis Notificaciones</h3>
                <span th:if="${totalNoLeidas > 0}"
                      class="bg-red-100 text-red-800 text-sm font-medium px-3 py-1 rounded-full">
                    <span th:text="${totalNoLeidas}"></span> sin leer
                </span>
            </div>

            <div th:if="${notificaciones.size() > 0}" class="divide-y divide-gray-100">
                <div th:each="notif : ${notificaciones}"
                     th:class="'p-6 cursor-pointer notification-item hover:bg-gray-50 transition-colors' + (${notif.leido} ? ' notification-unread' : '')">

                    <div class="flex justify-between items-start w-full">
                        <div>
                            <h4 class="font-semibold" th:text="${notif.mensajeNotificacion}"></h4>
                            <p class="text-sm text-gray-500"
                               th:text="${#temporals.format(notif.fechaNotificacion, 'dd/MM/yyyy HH:mm')}"></p>
                        </div>

                        <!-- Botón Marcar Leída -->
                        <form th:action="@{'/notificaciones/' + ${notif.idNotificacion} + '/marcar'}" method="post">
                            <button type="submit" class="text-gray-400 hover:text-gray-600">
                                <i th:class="'bx ' + (${notif.leido} ? 'bx-envelope-open' : 'bx-envelope')"></i>
                            </button>
                        </form>
                    </div>

                    <!-- Switch según el tipo de notificación -->
                    <div class="mt-3" th:switch="${notif.tipo}">
                        <a th:case="'Citas'"
                           href="/citas/mis-citas"
                           class="inline-block px-4 py-2 rounded-lg text-white font-semibold gradient-bg hover:opacity-90">
                            Ver en mis Citas
                        </a>

                        <a th:case="'Ventas'"
                           th:href="${esVendedor} ? '/ventas/mis-ventas' : '/compras/mis-compras'"
                           class="inline-block px-4 py-2 rounded-lg text-white font-semibold gradient-bg hover:opacity-90">
                            <span th:text="${esVendedor} ? 'Ver en mis Ventas' : 'Ver en mis Compras'"></span>
                        </a>

                        <a th:case="'Sistema'"
                           href="/perfil"
                           class="inline-block px-4 py-2 rounded-lg text-white font-semibold gradient-bg hover:opacity-90">
                            Ir a mi Perfil
                        </a>

                        <a th:case="'Productos'"
                           href="/productos"
                           class="inline-block px-4 py-2 rounded-lg text-white font-semibold gradient-bg hover:opacity-90">
                            Ir a Productos
                        </a>

                        <a th:case="'Disponibilidades'"
                           href="/productos"
                           class="inline-block px-4 py-2 rounded-lg text-white font-semibold gradient-bg hover:opacity-90">
                            Ir a Mi calendario
                        </a>
                    </div>
                    <a href="/productos"
                       class="inline-block px-4 py-2 rounded-lg text-white font-semibold bg-red-500 hover:opacity-90">
                        Borrar
                    </a>
                </div>
            </div>


            <!-- VACÍO -->
            <div th:if="${notificaciones.size() == 0}" class="p-12 text-center">
                <i class="bx bx-bell-off text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-500">No hay notificaciones</h3>
                <p class="text-gray-400">Cuando tengas nuevas notificaciones aparecerán aquí</p>
            </div>
        </div>
    </main>
</div>

<script>
    // Datos de ejemplo - en producción vendrían del servidor
    const notificacionesData = [
        {
            id: 1,
            tipo: 'producto',
            titulo: 'Nuevo interés en tu producto',
            mensaje: 'Juan Pérez ha mostrado interés en tu "Ganado Holstein Premium". Ha solicitado más información sobre disponibilidad.',
            fecha: '2024-01-15T10:30:00',
            leida: false,
            acciones: {
                primaria: { texto: 'Ver Producto', accion: 'verProducto(123)' },
                secundaria: { texto: 'Contactar Cliente', accion: 'contactarCliente(456)' }
            }
        },
        {
            id: 2,
            tipo: 'venta',
            titulo: 'Venta completada',
            mensaje: 'Se ha completado exitosamente la venta de "Semillas de Maíz Híbrido" por $250.000 COP.',
            fecha: '2024-01-15T09:15:00',
            leida: false,
            acciones: {
                primaria: { texto: 'Ver Detalles', accion: 'verVenta(789)' },
                secundaria: { texto: 'Descargar Factura', accion: 'descargarFactura(789)' }
            }
        },
        {
            id: 3,
            tipo: 'cita',
            titulo: 'Recordatorio de cita',
            mensaje: 'Tienes una cita programada mañana a las 2:00 PM con María González para evaluar ganado bovino.',
            fecha: '2024-01-14T16:45:00',
            leida: true,
            acciones: {
                primaria: { texto: 'Ver Cita', accion: 'verCita(321)' },
                secundaria: { texto: 'Reprogramar', accion: 'reprogramarCita(321)' }
            }
        },
        {
            id: 4,
            tipo: 'sistema',
            titulo: 'Actualización de perfil',
            mensaje: 'Tu perfil ha sido verificado exitosamente. Ahora puedes acceder a todas las funcionalidades premium.',
            fecha: '2024-01-14T14:20:00',
            leida: true
        },
        {
            id: 5,
            tipo: 'producto',
            titulo: 'Producto próximo a vencer',
            mensaje: 'Tu publicación "Fertilizante Orgánico" expirará en 3 días. Renueva para mantener la visibilidad.',
            fecha: '2024-01-14T11:30:00',
            leida: false,
            acciones: {
                primaria: { texto: 'Renovar Publicación', accion: 'renovarProducto(654)' },
                secundaria: { texto: 'Editar Producto', accion: 'editarProducto(654)' }
            }
        }
    ];

    let notificacionesFiltradas = [...notificacionesData];
    let filtroActual = 'todas';

    function formatearFecha(fechaISO) {
        const fecha = new Date(fechaISO);
        const ahora = new Date();
        const diferencia = ahora - fecha;
        const minutos = Math.floor(diferencia / 60000);
        const horas = Math.floor(diferencia / 3600000);
        const dias = Math.floor(diferencia / 86400000);

        if (minutos < 60) return `Hace ${minutos} minutos`;
        if (horas < 24) return `Hace ${horas} horas`;
        if (dias < 7) return `Hace ${dias} días`;
        return fecha.toLocaleDateString('es-ES');
    }

    function getIconoTipo(tipo) {
        const iconos = {
            producto: 'bx-package',
            venta: 'bx-dollar',
            cita: 'bx-calendar',
            sistema: 'bx-cog'
        };
        return iconos[tipo] || 'bx-bell';
    }

    function renderizarNotificaciones() {
        const container = document.getElementById('notifications-container');
        const emptyState = document.getElementById('empty-state');

        if (notificacionesFiltradas.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }

        emptyState.classList.add('hidden');

        container.innerHTML = notificacionesFiltradas.map(notif => `
            <div class="notification-item notification-${notif.tipo} ${!notif.leida ? 'notification-unread' : ''} p-6 cursor-pointer hover:bg-gray-50 transition-colors"
                 onclick="abrirDetalleNotificacion(${notif.id})" data-tipo="${notif.tipo}" data-leida="${notif.leida}">
                <div class="flex items-start space-x-4">
                    <div class="flex-shrink-0">
                        <i class="bx ${getIconoTipo(notif.tipo)} text-2xl ${getColorTipo(notif.tipo)}"></i>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between mb-1">
                            <h4 class="text-sm font-semibold text-gray-900 truncate">${notif.titulo}</h4>
                            <div class="flex items-center space-x-2">
                                ${!notif.leida ? '<span class="badge-new text-xs font-medium px-2 py-1 rounded-full text-white">Nuevo</span>' : ''}
                                <span class="text-xs text-gray-500">${formatearFecha(notif.fecha)}</span>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 line-clamp-2">${notif.mensaje}</p>
                        ${notif.acciones ? `
                            <div class="mt-3 flex space-x-2">
                                <button onclick="event.stopPropagation(); ${notif.acciones.primaria.accion}"
                                        class="text-xs bg-emerald-100 text-emerald-700 px-3 py-1 rounded-full hover:bg-emerald-200 transition-colors">
                                    ${notif.acciones.primaria.texto}
                                </button>
                                ${notif.acciones.secundaria ? `
                                    <button onclick="event.stopPropagation(); ${notif.acciones.secundaria.accion}"
                                            class="text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">
                                        ${notif.acciones.secundaria.texto}
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="event.stopPropagation(); marcarComoLeida(${notif.id})"
                                class="text-gray-400 hover:text-gray-600 transition-colors"
                                title="${notif.leida ? 'Marcar como no leída' : 'Marcar como leída'}">
                            <i class="bx ${notif.leida ? 'bx-envelope-open' : 'bx-envelope'} text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');

        actualizarContadores();
    }

    function getColorTipo(tipo) {
        const colores = {
            producto: 'text-blue-500',
            venta: 'text-green-500',
            cita: 'text-amber-500',
            sistema: 'text-purple-500'
        };
        return colores[tipo] || 'text-gray-500';
    }

    function actualizarContadores() {
        const contadores = {
            todas: notificacionesData.length,
            producto: notificacionesData.filter(n => n.tipo === 'producto').length,
            venta: notificacionesData.filter(n => n.tipo === 'venta').length,
            cita: notificacionesData.filter(n => n.tipo === 'cita').length,
            sistema: notificacionesData.filter(n => n.tipo === 'sistema').length
        };

        Object.keys(contadores).forEach(tipo => {
            const elemento = document.getElementById(`count-${tipo}`);
            if (elemento) elemento.textContent = contadores[tipo];
        });

        const noLeidas = notificacionesData.filter(n => !n.leida).length;
        document.getElementById('unread-number').textContent = noLeidas;

        const unreadBadge = document.getElementById('unread-count');
        if (noLeidas === 0) {
            unreadBadge.classList.add('hidden');
        } else {
            unreadBadge.classList.remove('hidden');
        }
    }

    function filtrarNotificaciones(tipo) {
        filtroActual = tipo;

        // Actualizar botones de filtro
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('filter-active');
            btn.classList.add('border', 'border-gray-300', 'text-gray-700');
        });

        const btnActivo = document.querySelector(`[data-filter="${tipo}"]`);
        btnActivo.classList.add('filter-active');
        btnActivo.classList.remove('border', 'border-gray-300', 'text-gray-700');

        // Filtrar notificaciones
        if (tipo === 'todas') {
            notificacionesFiltradas = [...notificacionesData];
        } else {
            notificacionesFiltradas = notificacionesData.filter(n => n.tipo === tipo);
        }

        renderizarNotificaciones();
    }

    function marcarComoLeida(id) {
        const notificacion = notificacionesData.find(n => n.id === id);
        if (notificacion) {
            notificacion.leida = !notificacion.leida;

            // Aquí harías la petición al servidor
            // fetch(`/api/notificaciones/${id}/marcar-leida`, { method: 'POST' })

            renderizarNotificaciones();
        }
    }

    function marcarTodasLeidas() {
        notificacionesData.forEach(n => n.leida = true);

        // Aquí harías la petición al servidor
        // fetch('/api/notificaciones/marcar-todas-leidas', { method: 'POST' })

        renderizarNotificaciones();
    }

    function abrirDetalleNotificacion(id) {
        const notificacion = notificacionesData.find(n => n.id === id);
        if (!notificacion) return;

        document.getElementById('modalTitle').textContent = notificacion.titulo;
        document.getElementById('modalTipo').textContent = notificacion.tipo.charAt(0).toUpperCase() + notificacion.tipo.slice(1);
        document.getElementById('modalMensaje').textContent = notificacion.mensaje;
        document.getElementById('modalFecha').textContent = new Date(notificacion.fecha).toLocaleString('es-ES');

        const accionesDiv = document.getElementById('modalAcciones');
        if (notificacion.acciones) {
            accionesDiv.classList.remove('hidden');
            document.getElementById('modalAccionPrimaria').textContent = notificacion.acciones.primaria.texto;
            document.getElementById('modalAccionPrimaria').onclick = () => eval(notificacion.acciones.primaria.accion);

            if (notificacion.acciones.secundaria) {
                document.getElementById('modalAccionSecundaria').textContent = notificacion.acciones.secundaria.texto;
                document.getElementById('modalAccionSecundaria').onclick = () => eval(notificacion.acciones.secundaria.accion);
                document.getElementById('modalAccionSecundaria').classList.remove('hidden');
            } else {
                document.getElementById('modalAccionSecundaria').classList.add('hidden');
            }
        } else {
            accionesDiv.classList.add('hidden');
        }

        // Marcar como leída al abrir
        if (!notificacion.leida) {
            marcarComoLeida(id);
        }

        const modal = document.getElementById('notificationModal');
        modal.classList.remove('opacity-0', 'invisible');
        modal.classList.add('opacity-100', 'visible');
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }

    function closeNotificationModal() {
        const modal = document.getElementById('notificationModal');
        modal.classList.add('opacity-0', 'invisible');
        modal.classList.remove('opacity-100', 'visible');
        modal.querySelector('.transform').classList.add('scale-95');
        modal.querySelector('.transform').classList.remove('scale-100');
    }

    // Funciones de ejemplo para las acciones
    function verProducto(id) { console.log('Ver producto:', id); closeNotificationModal(); }
    function contactarCliente(id) { console.log('Contactar cliente:', id); closeNotificationModal(); }
    function verVenta(id) { console.log('Ver venta:', id); closeNotificationModal(); }
    function descargarFactura(id) { console.log('Descargar factura:', id); closeNotificationModal(); }
    function verCita(id) { console.log('Ver cita:', id); closeNotificationModal(); }
    function reprogramarCita(id) { console.log('Reprogramar cita:', id); closeNotificationModal(); }
    function renovarProducto(id) { console.log('Renovar producto:', id); closeNotificationModal(); }
    function editarProducto(id) { console.log('Editar producto:', id); closeNotificationModal(); }

    // Inicializar al cargar la página
    document.addEventListener('DOMContentLoaded', function() {
        renderizarNotificaciones();
    });

    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        const arrow = document.getElementById('dropdownArrow');

        if (dropdown.classList.contains('opacity-0')) {
            // Mostrar dropdown
            dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.add('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            // Ocultar dropdown
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const userButton = event.target.closest('[onclick="toggleUserDropdown()"]');

        if (!userButton && !dropdown.contains(event.target)) {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            document.getElementById('dropdownArrow').style.transform = 'rotate(0deg)';
        }
    });
</script>

</body>
</html>
