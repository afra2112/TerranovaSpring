<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${producto.nombreProducto} + ' - AgroMarket'">Detalle Producto - AgroMarket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#388e3c',
                        'secondary': '#ffcf00'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            transition: all 0.3s ease;
        }

        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
        }

        #map {
            height: 400px;
            border-radius: 1rem;
            z-index: 1;
        }

        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
        }

        .carousel-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .carousel-image:hover {
            transform: scale(1.05);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .availability-item {
            transition: all 0.3s ease;
        }

        .availability-item:hover {
            border-color: #059669;
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.05) 0%, rgba(16, 185, 129, 0.05) 100%);
            transform: translateX(5px);
        }

        .feature-card {
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            transform: scale(1.02);
        }

        /* Carousel Navigation */
        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .carousel-nav:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .carousel-nav.prev {
            left: 20px;
        }

        .carousel-nav.next {
            right: 20px;
        }

        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="bg-gray-50">

<!-- Navbar Fragment -->
<div th:replace="fragments/comprador/navbarComprador :: navbarComprador"></div>

<div class="container mx-auto px-4 py-8 max-w-7xl">

    <!-- Breadcrumb -->
    <nav class="mb-6 fade-in-up">
        <ol class="flex items-center space-x-2 text-sm">
            <li><a th:href="@{/comprador/explorar}" class="text-primary hover:text-green-700 transition-colors font-medium">Productos</a></li>
            <li><i class='bx bx-chevron-right text-gray-400'></i></li>
            <li class="text-gray-600 font-medium" th:text="${producto.nombreProducto}">Producto</li>
        </ol>
    </nav>

    <div class="grid lg:grid-cols-3 gap-8">

        <!-- Left Column - Images & Details -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Image Carousel -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden fade-in-up carousel-container">
                <div class="relative">
                    <div id="carousel" class="relative">
                        <div th:each="imagen, iterStat : ${producto.imagenes}"
                             th:class="${iterStat.index == 0} ? 'carousel-slide active' : 'carousel-slide hidden'">
                            <img th:src="${imagen.nombreArchivo}"
                                 class="carousel-image"
                                 th:alt="${producto.nombreProducto}">
                        </div>
                    </div>

                    <!-- Navigation Arrows -->
                    <div class="carousel-nav prev" onclick="changeSlide(-1)">
                        <i class='bx bx-chevron-left text-2xl text-gray-700'></i>
                    </div>
                    <div class="carousel-nav next" onclick="changeSlide(1)">
                        <i class='bx bx-chevron-right text-2xl text-gray-700'></i>
                    </div>

                    <!-- Indicators -->
                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-10">
                        <span th:each="imagen, iterStat : ${producto.imagenes}"
                              th:onclick="'goToSlide(' + ${iterStat.index} + ')'"
                              th:class="${iterStat.index == 0} ? 'carousel-indicator active' : 'carousel-indicator'"
                              class="w-3 h-3 rounded-full bg-white bg-opacity-50 cursor-pointer transition-all hover:bg-opacity-100">
                        </span>
                    </div>
                </div>
            </div>

            <!-- Product Header -->
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in-up card-hover">
                <div class="flex items-start justify-between mb-6">
                    <div class="flex-1">
                        <h1 class="text-4xl font-bold text-gray-900 mb-3" th:text="${producto.nombreProducto}">Nombre del Producto</h1>
                        <div class="flex items-center gap-3 text-gray-600">
                            <i class='bx bx-map text-primary text-xl'></i>
                            <span class="text-lg" th:text="${producto.ciudad.nombreCiudad}">Ciudad</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-500 mb-2">Precio</p>
                        <p class="text-5xl font-bold gradient-bg bg-clip-text text-transparent">
                            $<span th:text="${#numbers.formatInteger(producto.precioProducto, 0, 'COMMA')}">0</span>
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-4 mb-6">
                    <span class="px-6 py-2 bg-gradient-to-r from-green-100 to-emerald-100 text-green-700 rounded-full text-sm font-semibold flex items-center gap-2">
                        <i class='bx bx-check-circle text-lg'></i>
                        <span th:text="${producto.estado}">Disponible</span>
                    </span>
                    <span class="text-sm text-gray-500 flex items-center gap-2">
                        <i class='bx bx-calendar'></i>
                        Publicado: <span th:text="${#temporals.format(producto.fechaPublicacion, 'dd/MM/yyyy')}">01/01/2024</span>
                    </span>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class='bx bx-info-circle text-primary text-2xl'></i>
                        Descripción
                    </h3>
                    <p class="text-gray-600 leading-relaxed text-lg" th:text="${producto.descripcion}">Descripción del producto</p>
                </div>
            </div>

            <!-- Specific Product Details -->
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in-up card-hover">
                <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <i class='bx bx-list-ul text-primary text-2xl'></i>
                    Características Detalladas
                </h3>

                <!-- Terreno Details -->
                <div th:if="${producto.tipoP == 'Terreno'}" class="grid md:grid-cols-2 gap-4">
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-ruler text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tamaño del Terreno</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.tamanoTerreno} + ' m²'">0 m²</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-layer text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tipo de Terreno</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.tipoTerreno}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-trending-up text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Topografía</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.topografiaTerreno}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-car text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Acceso</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.acceso}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-wrench text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Servicios</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.servicios}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-leaf text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Uso Actual</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.usoActual}">-</p>
                        </div>
                    </div>
                </div>

                <!-- Ganado Details -->
                <div th:if="${producto.tipoP == 'Ganado'}" class="grid md:grid-cols-2 gap-4">
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-dna text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Raza</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.razaGanado}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-trending-up text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Peso</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.pesoGanado} + ' kg'">0 kg</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-calendar text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Edad</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.edadGanado} + ' años'">0 años</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-male-female text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Género</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.generoGanado}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-category text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tipo de Ganado</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.tipoGanado}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-heart text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Estado Sanitario</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.estadoSanitario}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-hash text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Cantidad</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.cantidad} + ' cabezas'">0 cabezas</p>
                        </div>
                    </div>
                </div>

                <!-- Finca Details -->
                <div th:if="${producto.tipoP == 'Finca'}" class="grid md:grid-cols-2 gap-4">
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-expand text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Espacio Total</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.espacioTotal}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-home text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Espacio Construido</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.espacioConstruido}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-layer text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Estrato</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.estratoFinca}">0</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-bed text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Habitaciones</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.numeroHabitaciones}">0</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-bath text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Baños</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.numeroBanos}">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map -->
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in-up card-hover">
                <h3 class="text-xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <i class='bx bx-map text-primary text-2xl'></i>
                    Ubicación del Producto
                </h3>
                <div id="map" class="w-full h-96 rounded-xl shadow-lg"></div>
                <div class="flex items-center gap-3 text-gray-600 bg-gray-50 p-4 rounded-xl mt-4">
                    <i class='bx bx-current-location text-primary text-2xl'></i>
                    <div>
                        <p class="text-sm text-gray-500">Ubicado en</p>
                        <p class="font-semibold text-gray-900 text-lg" th:text="${producto.ciudad.nombreCiudad}">Ciudad</p>
                    </div>
                </div>
            </div>


            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
            <script th:inline="javascript">
                document.addEventListener('DOMContentLoaded', function() {
                    const latitud = /*[[${producto.latitud}]]*/ 0;
                    const longitud = /*[[${producto.longitud}]]*/ 0;

                    if (!latitud || !longitud || latitud === 0 || longitud === 0) {
                        console.error('[v0] Coordenadas inválidas o no disponibles');
                        document.getElementById('map').innerHTML =
                            '<div class="flex items-center justify-center h-full bg-gray-100 rounded-xl">' +
                            '<div class="text-center">' +
                            '<i class="bx bx-map-pin text-gray-400 text-6xl mb-4"></i>' +
                            '<p class="text-gray-500 font-medium">Ubicación no disponible</p>' +
                            '</div></div>';
                        return;
                    }

                    try {
                        const map = L.map('map').setView([latitud, longitud], 15);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors',
                            maxZoom: 19
                        }).addTo(map);

                        const marker = L.marker([latitud, longitud]).addTo(map);
                        marker.bindPopup('<b>Ubicación del producto</b><br>' +
                            'Lat: ' + latitud.toFixed(6) + '<br>' +
                            'Lng: ' + longitud.toFixed(6))
                            .openPopup();

                        setTimeout(function() {
                            map.invalidateSize();
                            console.log('[v0] Mapa inicializado correctamente');
                        }, 100);

                    } catch (error) {
                        console.error('[v0] Error al inicializar el mapa:', error);
                    }
                });

                let currentSlide = 0;
                const slides = document.querySelectorAll('.carousel-slide');
                const indicators = document.querySelectorAll('.carousel-indicator');

            </script>
        </div>

        <!-- Right Column - Seller Info & Actions -->
        <div class="space-y-6">

            <!-- Right Column -->
            <div class="lg:col-span-1 space-y-8 sticky top-0">
                <!-- Seller Card -->
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in-up card-hover sticky top-4">
                    <h3 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <i class='bx bxs-badge-check text-green-500 text-6xl mb-4'></i>
                        Vendedor
                    </h3>

                    <div class="flex items-center gap-4 mb-6 p-4 bg-gradient-to-r from-gray-50 to-green-50 rounded-xl">
                        <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
                            <span th:text="${#strings.substring(producto.vendedor.nombres, 0, 1)}">V</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 text-lg" th:text="${producto.vendedor.nombres + ' ' + producto.vendedor.apellidos}">Nombre Vendedor</h4>
                            <p class="text-sm text-green-600 font-medium flex items-center gap-1">
                                <i class='bx bx-badge-check'></i>
                                Vendedor verificado
                            </p>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <div class="flex items-center gap-3 text-gray-600 p-3 bg-gray-50 rounded-lg">
                            <i class='bx bx-envelope text-primary text-xl'></i>
                            <span class="text-sm" th:text="${producto.vendedor.email}">email@example.com</span>
                        </div>
                        <div class="flex items-center gap-3 text-gray-600 p-3 bg-gray-50 rounded-lg">
                            <i class='bx bx-phone text-primary text-xl'></i>
                            <span class="text-sm" th:text="'+57 ' + ${producto.vendedor.telefono}">+57 123 456 7890</span>
                        </div>
                    </div>

                    <!-- Action Buttons with Auth Check -->
                    <div class="space-y-3">
                        <!-- Botón de agendar cita -->
                        <button
                                th:if="${usuario == null}"
                                onclick="window.location.href='/login'"
                                class="w-full gradient-btn text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg"
                        >
                            <i class='bx bx-calendar-check text-xl'></i>
                            Agendar Cita
                        </button>

                        <button
                                th:if="${usuario != null}"
                                onclick="scrollToAvailability()"
                                class="w-full gradient-btn text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg"
                        >
                            <i class='bx bx-heart text-xl'></i>
                            Guardar en Favoritos
                        </button>

                        <!-- Botón compartir -->
                        <button
                                onclick="compartir()"
                                class="w-full bg-gray-100 text-gray-700 font-bold py-4 rounded-xl transition-all duration-300 hover:bg-gray-200 flex items-center justify-center gap-2"
                        >
                            <i class='bx bx-share-alt text-xl'></i>
                            Compartir
                        </button>
                    </div>
                </div>

                <div id="availabilitySection"
                     class="bg-white rounded-2xl shadow-lg p-6 fade-in-up card-hover sticky top-[29rem]">
                    <h3 class="text-lg font-bold text-gray-900 mb-6 flex items-center gap-2">
                        <i class='bx bx-time text-primary text-2xl'></i>
                        Horarios Disponibles
                    </h3>

                    <div th:if="${yaTieneCita}" class="text-center py-10 flex flex-col items-center">
                        <i class='bx bxs-badge-check text-green-500 text-6xl mb-4'></i>
                        <p class="text-gray-700 font-semibold text-lg mb-4">
                            Ya tienes una cita agendada con este producto.
                        </p>
                        <a href="/comprador/citas"
                           class="mt-2 w-1/2 gradient-btn text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition-all duration-300">
                            <i class='bx bx-calendar text-xl'></i>
                            Ver mis citas
                        </a>
                    </div>

                    <div th:if="${!yaTieneCita}">
                        <div th:if="${#lists.isEmpty(producto.disponibilidades)}" class="text-center py-12">
                            <i class='bx bx-calendar-x text-gray-300 text-6xl mb-4'></i>
                            <p class="text-gray-500 font-medium">No hay horarios disponibles</p>
                            <p class="text-sm text-gray-400 mt-2">Contacta al vendedor para más información</p>
                        </div>

                        <div th:if="${!#lists.isEmpty(producto.disponibilidades)}"
                             class="space-y-3 max-h-96 overflow-y-auto pr-2">
                            <div th:each="disponibilidad : ${producto.disponibilidades}"
                                 th:if="${disponibilidad.disponible}"
                                 class="availability-item p-4 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary transition-colors"
                                 th:data-id="${disponibilidad.idDisponibilidad}"
                                 th:data-login="${usuario != null}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-4">
                                        <div class="w-14 h-14 bg-gradient-to-br from-green-100 to-emerald-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                            <i class='bx bx-calendar text-primary text-2xl'></i>
                                        </div>
                                        <div>
                                            <p class="font-bold text-gray-900 text-lg"
                                               th:text="${#temporals.format(disponibilidad.fecha, 'dd/MM/yyyy')}"></p>
                                            <p class="text-gray-600 flex items-center gap-2">
                                                <i class='bx bx-time-five'></i>
                                                <span th:text="${#temporals.format(disponibilidad.hora, 'HH:mm')}"></span>
                                            </p>
                                            <p th:if="${disponibilidad.descripcion != null}"
                                               class="text-sm text-gray-500 mt-1"
                                               th:text="${disponibilidad.descripcion}">Descripción</p>
                                        </div>
                                    </div>
                                    <i class='bx bx-chevron-right text-gray-400 text-2xl'></i>
                                </div>
                            </div>
                        </div>

                        <form id="formReservarCita" th:action="@{/comprador/citas/reservar-cita}" method="post" style="display: none;">
                            <input type="hidden" name="idDisponibilidad" id="idDisponibilidadInput">
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const items = document.querySelectorAll('.availability-item');
        const form = document.getElementById('formReservarCita');
        const input = document.getElementById('idDisponibilidadInput');

        items.forEach(item => {
            item.addEventListener('click', () => {
                const idDisponibilidad = item.getAttribute('data-id');
                const estaLogueado = item.getAttribute('data-login') === 'true';

                if (!estaLogueado) {
                    window.location.href = '/login';
                    return;
                }

                input.value = idDisponibilidad;
                form.submit();
            });
        });
    });

    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-slide');
    const indicators = document.querySelectorAll('.carousel-indicator');

    function showSlide(index) {
        slides.forEach((slide, i) => {
            if (i === index) {
                slide.classList.remove('hidden');
                slide.classList.add('active');
            } else {
                slide.classList.add('hidden');
                slide.classList.remove('active');
            }
        });

        indicators.forEach((indicator, i) => {
            if (i === index) {
                indicator.classList.add('active', 'bg-opacity-100');
            } else {
                indicator.classList.remove('active', 'bg-opacity-100');
            }
        });
    }

    function changeSlide(direction) {
        currentSlide += direction;
        if (currentSlide < 0) currentSlide = slides.length - 1;
        if (currentSlide >= slides.length) currentSlide = 0;
        showSlide(currentSlide);
    }

    function goToSlide(index) {
        currentSlide = index;
        showSlide(currentSlide);
    }

    setInterval(() => {
        changeSlide(1);
    }, 5000);

    function agregarFavorito() {
        // TODO: Implement favorite logic with backend
        alert('Producto agregado a favoritos');
    }

    function compartir() {
        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: window.location.href
            }).catch(err => console.log('Error sharing:', err));
        } else {
            navigator.clipboard.writeText(window.location.href);
            alert('Enlace copiado al portapapeles');
        }
    }

    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        const arrow = document.getElementById('dropdownArrow');

        if (dropdown.classList.contains('opacity-0')) {
            // Mostrar dropdown
            dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.add('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            // Ocultar dropdown
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const userButton = event.target.closest('[onclick="toggleUserDropdown()"]');

        if (!userButton && !dropdown.contains(event.target)) {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            document.getElementById('dropdownArrow').style.transform = 'rotate(0deg)';
        }
    });
</script>

</body>
</html>
