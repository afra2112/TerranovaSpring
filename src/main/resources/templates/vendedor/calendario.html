<!DOCTYPE html>
<html xmlns:th="www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - Panel Vendedor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'DM Sans', sans-serif; }

        /* Estilos mejorados para eventos del calendario con mejor visualización de duración */
        .fc-event {
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid rgba(0,0,0,0.2) !important;
        }

        .fc-event:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .fc-event-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 2px;
        }

        .fc-event-time {
            font-size: 0.75rem;
            opacity: 0.9;
            display: block;
        }

        /* Estados de citas con colores distintivos */
        .cita-PROGRAMADA-event {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
            border-left-color: #1e40af !important;
        }

        .cita-FINALIZADA_AUTOMATICAMENTE-event {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            border-left-color: #b45309 !important;
        }

        .cita-EN_CURSO-event {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            border-left-color: #047857 !important;
            animation: pulse 2s infinite;
        }

        .cita-FINALIZADA-event {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%) !important;
            border-left-color: #374151 !important;
            opacity: 0.7;
        }

        .cita-CANCELADA-event {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            border-left-color: #b91c1c !important;
            text-decoration: line-through;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .gradient-hero {
            background: linear-gradient(135deg, #064e3b 0%, #059669 50%, #10b981 100%);
        }

        .gradient-bg {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .gradient-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* Estilos mejorados para modales */
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        /* Badge styles para estados */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-programada { background: #dbeafe; color: #1e40af; }
        .badge-llena { background: #fef3c7; color: #b45309; }
        .badge-en-curso { background: #d1fae5; color: #047857; }
        .badge-finalizada { background: #e5e7eb; color: #374151; }
        .badge-cancelada { background: #fee2e2; color: #b91c1c; }

        /* Estilos para las cards de estadísticas */
        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.1);
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 10px;
        }

        /* Mejor visualización del calendario en timeGrid */
        .fc-timegrid-event {
            border-radius: 4px;
            overflow: hidden;
        }

        .fc-timegrid-event-harness {
            margin: 0 2px;
        }

        .fc-daygrid-event {
            white-space: normal;
        }
    </style>
</head>
<body class="bg-gray-50">

<div th:replace="fragments/vendedor/navbarVendedor :: navbarVendedor"></div>

<div class="ml-64 flex flex-col min-h-screen">
    <main class="py-10 px-8">

        <!-- Hero mejorado con estadísticas -->
        <div class="gradient-hero rounded-3xl p-8 mb-8 text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-black/10"></div>
            <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full"></div>
            <div class="absolute -bottom-5 -left-5 w-32 h-32 bg-white/5 rounded-full"></div>

            <div class="relative z-10 flex justify-between items-start">
                <div class="text-left max-w-xl">
                    <h1 class="text-4xl font-bold mb-2">Calendario de Citas</h1>
                    <p class="text-emerald-100 text-lg">Gestiona y visualiza todas tus citas programadas</p>
                </div>

                <button onclick="openDisponibilidadModal()"
                        class="bg-white/20 backdrop-blur-sm text-white border-2 border-white/40 px-6 py-3 rounded-xl font-semibold shadow-lg hover:bg-white hover:text-emerald-600 transition-all duration-300 flex items-center gap-2 transform hover:scale-105">
                    <i class='bx bx-calendar-plus text-xl'></i>
                    <span>Nueva Cita</span>
                </button>
            </div>

            <!-- Estadísticas rápidas en el hero -->
            <div class="relative z-10 grid grid-cols-4 gap-4 mt-8">
                <div class="bg-white/15 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-500/30 p-3 rounded-lg">
                            <i class='bx bx-calendar-check text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-emerald-100 text-sm">Programadas</p>
                            <p class="text-2xl font-bold" id="statProgramadas">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white/15 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <div class="flex items-center gap-3">
                        <div class="bg-orange-500/30 p-3 rounded-lg">
                            <i class='bx bx-group text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-emerald-100 text-sm">finalizadaAuto</p>
                            <p class="text-2xl font-bold" id="statfinalizadaAuto">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white/15 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <div class="flex items-center gap-3">
                        <div class="bg-green-500/30 p-3 rounded-lg">
                            <i class='bx bx-timer text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-emerald-100 text-sm">En Curso</p>
                            <p class="text-2xl font-bold" id="statEnCurso">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white/15 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                    <div class="flex items-center gap-3">
                        <div class="bg-gray-500/30 p-3 rounded-lg">
                            <i class='bx bx-check-circle text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-emerald-100 text-sm">Finalizadas</p>
                            <p class="text-2xl font-bold" id="statFinalizadas">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel de filtros avanzados -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-gray-800 flex items-center gap-2">
                    <i class='bx bx-filter-alt text-xl'></i>
                    Filtros y Vista
                </h3>
                <button onclick="resetFilters()" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium flex items-center gap-1">
                    <i class='bx bx-refresh'></i>
                    Resetear
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <!-- Filtro por Estado -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estado de Cita</label>
                    <select id="filterEstado" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                        <option value="">Todos los estados</option>
                        <option value="PROGRAMADA">Programadas</option>
                        <option value="EN_CURSO">En Curso</option>
                        <option value="FINALIZADA">Finalizadas</option>
                        <option value="CANCELADA">Canceladas</option>
                    </select>
                </div>

                <!-- Filtro por Producto -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Producto</label>
                    <select id="filterProducto" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                        <option value="">Todos los productos</option>
                        <option th:each="producto : ${productos}" th:text="${producto.nombreProducto}" th:value="${producto.idProducto}"></option>
                    </select>
                </div>

                <!-- Filtro por Rango de Fechas -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Desde</label>
                    <input type="date" id="filterFechaDesde" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hasta</label>
                    <input type="date" id="filterFechaHasta" onchange="applyFilters()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-transparent">
                </div>
            </div>
        </div>

        <!-- Leyenda mejorada con nuevos estados -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6">
            <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                <i class='bx bx-palette text-xl'></i>
                Leyenda de Estados
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
                    <div class="w-4 h-4 rounded bg-gradient-to-br from-blue-500 to-blue-600 shadow-sm"></div>
                    <div>
                        <p class="text-sm font-semibold text-gray-800">Programada</p>
                        <p class="text-xs text-gray-600">Cita confirmada</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3 bg-orange-50 rounded-lg">
                    <div class="w-4 h-4 rounded bg-gradient-to-br from-orange-500 to-orange-600 shadow-sm"></div>
                    <div>
                        <p class="text-sm font-semibold text-gray-800">Finalizada Auto</p>
                        <p class="text-xs text-gray-600">Sin interesados</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg">
                    <div class="w-4 h-4 rounded bg-gradient-to-br from-green-500 to-green-600 shadow-sm"></div>
                    <div>
                        <p class="text-sm font-semibold text-gray-800">En Curso</p>
                        <p class="text-xs text-gray-600">Activa ahora</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-4 h-4 rounded bg-gradient-to-br from-gray-500 to-gray-600 shadow-sm"></div>
                    <div>
                        <p class="text-sm font-semibold text-gray-800">Finalizada</p>
                        <p class="text-xs text-gray-600">Completada</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3 bg-red-50 rounded-lg">
                    <div class="w-4 h-4 rounded bg-gradient-to-br from-red-500 to-red-600 shadow-sm"></div>
                    <div>
                        <p class="text-sm font-semibold text-gray-800">Cancelada</p>
                        <p class="text-xs text-gray-600">No realizada</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendario con mejor configuración para mostrar duración -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div id="calendar"></div>
        </div>
    </main>
</div>

<!-- Modal de disponibilidad mejorado -->
<div id="disponibilidadModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 transform scale-95 transition-transform duration-300 shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2" id="disponibilidadModalTitle">
                <i class='bx bx-calendar-plus text-emerald-600'></i>
                Agregar Nueva Cita
            </h3>
            <button onclick="closeDisponibilidadModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <form id="disponibilidadForm" th:action="@{/vendedor/citas/mi-calendario/registrar-cita}" method="post">
            <input type="hidden" name="vieneDe" value="calendario">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class='bx bx-calendar'></i>
                        Fecha de la Cita
                    </label>
                    <input required type="date" id="disponibilidadFecha" name="fecha"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                            <i class='bx bx-time'></i>
                            Hora Inicio
                        </label>
                        <input required type="time" id="disponibilidadHoraInicio" name="horaInicio"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                            <i class='bx bx-time-five'></i>
                            Hora Fin
                        </label>
                        <input required type="time" id="disponibilidadHoraFin" name="horaFin"
                               class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class='bx bx-group'></i>
                        Cupo Máximo de Personas
                    </label>
                    <input required type="number" name="cupoMaximo" min="1" placeholder="Ej: 5"
                           class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class='bx bx-package'></i>
                        Producto
                    </label>
                    <select required id="disponibilidadProducto" name="idProducto"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all">
                        <option value="">Selecciona un producto</option>
                        <option th:each="producto : ${productos}" th:text="${producto.nombreProducto}" th:value="${producto.idProducto}"></option>
                        <option th:if="${productos.isEmpty()}" disabled>No tienes productos publicados aún</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class='bx bx-message-square-detail'></i>
                        Descripción (Opcional)
                    </label>
                    <textarea id="disponibilidadDescripcion" rows="3" name="descripcion"
                              class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all"
                              placeholder="Ej: Visita a finca, Evaluación de ganado..."></textarea>
                </div>
            </div>

            <div class="flex space-x-3 mt-6">
                <button type="submit"
                        class="flex-1 gradient-bg text-white px-4 py-3 rounded-xl font-semibold hover:shadow-lg transform hover:scale-105 transition-all">
                    Crear Cita
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de detalle de cita completamente rediseñado -->
<div id="detalleDisponibilidadModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 opacity-0 invisible transition-all duration-300">
    <div class="bg-white rounded-2xl max-w-3xl w-full mx-4 transform scale-95 transition-transform duration-300 shadow-2xl max-h-[90vh] overflow-y-auto custom-scrollbar">
        <!-- Header del modal -->
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex justify-between items-center z-10">
            <h3 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                <i class='bx bx-calendar-event text-emerald-600'></i>
                <span id="detalleDisponibilidadModalTitle">Detalle de Cita</span>
            </h3>
            <button onclick="closeDetalleDisponibilidadModal()" class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 p-2 rounded-lg transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <div class="p-6">
            <!-- Badge de estado -->
            <div class="mb-6">
                <span id="estadoBadge" class="badge"></span>
            </div>

            <!-- Imagen y info del producto -->
            <div class="bg-gradient-to-br from-emerald-50 to-green-50 rounded-xl p-6 mb-6 border border-emerald-100">
                <div class="flex gap-4">
                    <img id="imagenProducto" src="/placeholder.svg" alt="Producto" class="w-32 h-32 object-cover rounded-lg shadow-md">
                    <div class="flex-1">
                        <h4 class="text-xl font-bold text-gray-800 mb-2" id="nombreProducto"></h4>
                        <p class="text-gray-600 flex items-center gap-2 mb-1">
                            <i class='bx bx-map text-emerald-600'></i>
                            <span id="ubicacion"></span>
                        </p>
                        <p class="text-gray-600 flex items-center gap-2">
                            <i class='bx bx-dollar-circle text-emerald-600'></i>
                            <span id="precioProducto"></span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Info de la cita -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-100">
                    <p class="text-sm text-blue-600 font-semibold mb-1 flex items-center gap-2">
                        <i class='bx bx-calendar'></i>
                        Fecha
                    </p>
                    <p class="text-lg font-bold text-gray-800" id="detalleDisponibilidadFecha"></p>
                </div>

                <div class="bg-purple-50 rounded-xl p-4 border border-purple-100">
                    <p class="text-sm text-purple-600 font-semibold mb-1 flex items-center gap-2">
                        <i class='bx bx-time'></i>
                        Horario
                    </p>
                    <p class="text-lg font-bold text-gray-800" id="detalleDisponibilidadHora"></p>
                </div>

                <div class="bg-orange-50 rounded-xl p-4 border border-orange-100">
                    <p class="text-sm text-orange-600 font-semibold mb-1 flex items-center gap-2">
                        <i class='bx bx-group'></i>
                        Cupo
                    </p>
                    <p class="text-lg font-bold text-gray-800" id="cupoInfo"></p>
                </div>

                <div class="bg-green-50 rounded-xl p-4 border border-green-100">
                    <p class="text-sm text-green-600 font-semibold mb-1 flex items-center gap-2">
                        <i class='bx bx-user-check'></i>
                        Inscritos
                    </p>
                    <p class="text-lg font-bold text-gray-800" id="inscritosInfo"></p>
                </div>
            </div>

            <!-- Descripción -->
            <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-200">
                <p class="text-sm text-gray-600 font-semibold mb-2 flex items-center gap-2">
                    <i class='bx bx-message-square-detail'></i>
                    Descripción
                </p>
                <p class="text-gray-800" id="detalleDisponibilidadDescripcion">No hay descripción</p>
            </div>

            <!-- Lista de asistentes -->
            <div class="mb-6">
                <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class='bx bx-list-ul text-emerald-600'></i>
                    Asistentes
                </h4>
                <div id="listaAsistentes" class="space-y-3">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>

            <!-- Botones de acción -->
            <div class="flex gap-3 pt-4 border-t border-gray-200">
                <a href="#" id="detalleDisponibilidadProductoLink"
                   class="flex-1 gradient-bg text-white px-4 py-3 rounded-xl font-semibold text-center hover:shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-2">
                    <i class='bx bx-calendar'></i>
                    Ver Detalle
                </a>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    let calendar;
    let allCitas = [];

    function updateStats(citas) {
        const stats = {
            programadas: citas.filter(c => c.estadoCita === 'PROGRAMADA').length,
            finalizadaAuto: citas.filter(c => c.estadoCita === 'FINALIZADA_AUTOMATICAMENTE').length,
            enCurso: citas.filter(c => c.estadoCita === 'EN_CURSO').length,
            finalizadas: citas.filter(c => c.estadoCita === 'FINALIZADA').length
        };

        document.getElementById('statProgramadas').textContent = stats.programadas;
        document.getElementById('statfinalizadaAuto').textContent = stats.finalizadaAuto;
        document.getElementById('statEnCurso').textContent = stats.enCurso;
        document.getElementById('statFinalizadas').textContent = stats.finalizadas;
    }

    function applyFilters() {
        const estado = document.getElementById('filterEstado').value;
        const producto = document.getElementById('filterProducto').value;
        const fechaDesde = document.getElementById('filterFechaDesde').value;
        const fechaHasta = document.getElementById('filterFechaHasta').value;

        let citasFiltradas = allCitas.filter(cita => {
            if (estado && cita.estadoCita !== estado) return false;
            if (producto && cita.productoDTO.idProducto != producto) return false;
            if (fechaDesde && cita.fecha < fechaDesde) return false;
            if (fechaHasta && cita.fecha > fechaHasta) return false;
            return true;
        });

        const events = citasFiltradas.map(c => ({
            title: c.nombreProducto,
            start: c.fecha + "T" + c.horaInicio,
            end: c.fecha + "T" + c.horaFin,
            className: `cita-${c.estadoCita}-event`,
            extendedProps: { ...c }
        }));

        calendar.removeAllEvents();
        calendar.addEventSource(events);
        updateStats(citasFiltradas);
    }

    document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('disponibilidadForm');
    const fechaInput = document.getElementById('disponibilidadFecha');
    const horaInicioInput = document.getElementById('disponibilidadHoraInicio');
    const horaFinInput = document.getElementById('disponibilidadHoraFin');

    // ✅ Establecer fecha mínima como hoy
    const hoy = new Date().toISOString().split('T')[0];
    fechaInput.setAttribute('min', hoy);

    form.addEventListener('submit', function(e) {
        const fecha = fechaInput.value; //Usar el valor directo (formato YYYY-MM-DD)
        const horaInicio = horaInicioInput.value;
        const horaFin = horaFinInput.value;
        const ahora = new Date();

        // ✅ Validar que hora fin sea mayor que hora inicio
        if (horaInicio >= horaFin) {
            e.preventDefault();
            alert('La hora de fin debe ser posterior a la hora de inicio');
            return;
        }

        // ✅ Crear fecha correctamente en formato ISO
        const fechaHoraInicio = new Date(`${fecha}T${horaInicio}:00`);

        console.log('Debug:');
        console.log('- Fecha input:', fecha);
        console.log('- Hora inicio:', horaInicio);
        console.log('- DateTime construido:', fechaHoraInicio);
        console.log('- Ahora:', ahora);
        console.log('- ¿Es pasado?', fechaHoraInicio < ahora);

        // ✅ Validar que la cita no sea en el pasado (con margen de 1 minuto)
        const unMinutoAntes = new Date(ahora.getTime() - 60000); // 1 minuto de margen
        if (fechaHoraInicio < unMinutoAntes) {
            e.preventDefault();
            alert('No puedes crear una cita en el pasado');
            return;
        }

        // ✅ Validar duración mínima (30 minutos)
        const [horaIni, minIni] = horaInicio.split(':').map(Number);
        const [horaFn, minFn] = horaFin.split(':').map(Number);
        const duracionMinutos = (horaFn * 60 + minFn) - (horaIni * 60 + minIni);

        if (duracionMinutos < 30) {
            e.preventDefault();
            alert('La cita debe durar al menos 30 minutos');
            return;
        }
    });
});

    function resetFilters() {
        document.getElementById('filterEstado').value = '';
        document.getElementById('filterProducto').value = '';
        document.getElementById('filterFechaDesde').value = '';
        document.getElementById('filterFechaHasta').value = '';
        applyFilters();
    }

    function getBadgeHTML(estado) {
        const badges = {
            'PROGRAMADA': '<span class="badge badge-programada"><i class="bx bx-calendar-check"></i> Programada</span>',
            'FINALIZADA_AUTOMATICAMENTE': '<span class="badge badge-llena"><i class="bx bx-group"></i> Finalizada Automaticamente</span>',
            'EN_CURSO': '<span class="badge badge-en-curso"><i class="bx bx-timer"></i> En Curso</span>',
            'FINALIZADA': '<span class="badge badge-finalizada"><i class="bx bx-check-circle"></i> Finalizada</span>',
            'CANCELADA': '<span class="badge badge-cancelada"><i class="bx bx-x-circle"></i> Cancelada</span>'
        };
        return badges[estado] || '';
    }

    function openDetalleDisponibilidadModal(cita) {
        const inscritos = cita.asistenciasDTO.filter(a => a.estado === 'INSCRITO').length;
        const enEspera = cita.asistenciasDTO.filter(a => a.estado === 'EN_ESPERA').length;

        // Set estado badge
        document.getElementById('estadoBadge').innerHTML = getBadgeHTML(cita.estadoCita);

        // Set información del producto
        document.getElementById('nombreProducto').textContent = cita.nombreProducto;
        document.getElementById('ubicacion').textContent = cita.ubicacion;
        document.getElementById('precioProducto').textContent = new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(cita.productoDTO.precioProducto);

        // Set imagen del producto
        const imagenUrl = cita.productoDTO.imagenes && cita.productoDTO.imagenes.length > 0
            ? cita.productoDTO.imagenes[0].nombreArchivo
            : '/placeholder.svg?height=128&width=128';
        document.getElementById('imagenProducto').src = imagenUrl;

        // Set información de la cita
        document.getElementById('detalleDisponibilidadFecha').textContent = new Date(cita.fecha).toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('detalleDisponibilidadHora').textContent = cita.horaInicio + " - " + cita.horaFin;
        document.getElementById('cupoInfo').textContent = `${inscritos} / ${cita.cupoMaximo}`;
        document.getElementById('inscritosInfo').textContent = `${inscritos} confirmados, ${enEspera} en espera`;
        document.getElementById('detalleDisponibilidadDescripcion').textContent = cita.descripcion || 'No hay descripción';

        // Set enlaces
        document.getElementById('detalleDisponibilidadProductoLink').href = '/vendedor/citas/detalle/' + cita.idCita;

        const listaAsistentes = document.getElementById('listaAsistentes');
        if (cita.asistenciasDTO && cita.asistenciasDTO.length > 0) {
            listaAsistentes.innerHTML = cita.asistenciasDTO.map((asistencia, index) => {
                const estadoBadge = asistencia.estado === 'INSCRITO'
                    ? '<span class="badge badge-en-curso">Confirmado</span>'
                    : asistencia.estado === 'EN_ESPERA'
                        ? '<span class="badge badge-llena">En Espera</span>'
                        : '<span class="badge badge-cancelada">Cancelado</span>';

                return `
                    <div class="bg-gray-50 rounded-xl p-4 flex items-center justify-between border border-gray-200 hover:border-emerald-300 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="bg-emerald-100 text-emerald-600 w-10 h-10 rounded-full flex items-center justify-center font-bold">
                                ${asistencia.usuario.nombres.charAt(0)}${asistencia.usuario.apellidos.charAt(0)}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-800">${asistencia.usuario.nombres} ${asistencia.usuario.apellidos}</p>
                                <p class="text-sm text-gray-600">${asistencia.usuario.email}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            ${estadoBadge}
                            <p class="text-xs text-gray-500 mt-1">
                                ${new Date(asistencia.fechaInscripcion).toLocaleDateString('es-ES')}
                            </p>
                        </div>
                    </div>
                `;
            }).join('');
        } else {
            listaAsistentes.innerHTML = '<p class="text-gray-500 text-center py-4">No hay asistentes registrados aún</p>';
        }

        // Abrir modal
        const modal = document.getElementById('detalleDisponibilidadModal');
        modal.classList.remove('opacity-0', 'invisible');
        modal.classList.add('opacity-100', 'visible');
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }

    function closeDetalleDisponibilidadModal() {
        const modal = document.getElementById('detalleDisponibilidadModal');
        modal.classList.add('opacity-0', 'invisible');
        modal.classList.remove('opacity-100', 'visible');
        modal.querySelector('.transform').classList.add('scale-95');
        modal.querySelector('.transform').classList.remove('scale-100');
    }

    function openDisponibilidadModal(date = '') {
        document.getElementById('disponibilidadModalTitle').innerHTML = '<i class="bx bx-calendar-plus text-emerald-600"></i> Agregar Nueva Cita';
        document.getElementById('disponibilidadForm').reset();
        if (date) {
            document.getElementById('disponibilidadFecha').value = date;
        }
        const modal = document.getElementById('disponibilidadModal');
        modal.classList.remove('opacity-0','invisible');
        modal.classList.add('opacity-100','visible');
        modal.querySelector('.transform').classList.remove('scale-95');
        modal.querySelector('.transform').classList.add('scale-100');
    }

    function closeDisponibilidadModal() {
        const modal = document.getElementById('disponibilidadModal');
        modal.classList.add('opacity-0','invisible');
        modal.classList.remove('opacity-100','visible');
        modal.querySelector('.transform').classList.add('scale-95');
        modal.querySelector('.transform').classList.remove('scale-100');
    }

    const cedula = /*[[${cedula}]]*/;

    document.addEventListener('DOMContentLoaded', function() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek',
            locale: 'es',
            height: 'auto',
            slotMinTime: '06:00:00',
            slotMaxTime: '22:00:00',
            slotDuration: '00:30:00',
            expandRows: true,
            nowIndicator: true,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'Día'
            },
            events: function(fetchInfo, successCallback, failureCallback) {
                fetch(`/api/Citas/vendedor/${cedula}`)
                    .then(res => res.json())
                    .then(citas => {
                        allCitas = citas;
                        const citaEvents = citas.map(c => ({
                            title: c.nombreProducto,
                            start: c.fecha + "T" + c.horaInicio,
                            end: c.fecha + "T" + c.horaFin,
                            className: `cita-${c.estadoCita}-event`,
                            extendedProps: { ...c }
                        }));
                        successCallback(citaEvents);
                        updateStats(citas);
                    })
                    .catch(err => {
                        console.error('Error al cargar citas:', err);
                        failureCallback(err);
                    });
            },
            dateClick: function(info) {
                const date = info.date;
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');

                const formattedDate = `${year}-${month}-${day}`;
                openDisponibilidadModal(formattedDate);
            },
            eventClick: function(info) {
                openDetalleDisponibilidadModal(info.event.extendedProps);
            },
            eventContent: function(arg) {
                const asistencias = arg.event.extendedProps.asistenciasDTO || [];
                const inscritos = asistencias.filter(a => a.estado === 'INSCRITO').length;
                const cupoMaximo = arg.event.extendedProps.cupoMaximo || 0;

                return {
                    html: `
                        <div class="fc-event-main-frame p-1">
                            <div class="fc-event-title-container">
                                <div class="fc-event-title fc-sticky">${arg.event.title}</div>
                            </div>
                            <div class="fc-event-time text-xs opacity-90">
                                ${arg.timeText}
                            </div>
                            <div class="text-xs mt-1 opacity-90">
                                <i class="bx bx-group"></i> ${inscritos}/${cupoMaximo}
                            </div>
                        </div>
                    `
                };
            }
        });
        calendar.render();
    });

    // User dropdown
    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        const arrow = document.getElementById('dropdownArrow');

        if (dropdown.classList.contains('opacity-0')) {
            dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.add('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(180deg)';
        } else {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            arrow.style.transform = 'rotate(0deg)';
        }
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const userButton = event.target.closest('[onclick="toggleUserDropdown()"]');

        if (!userButton && !dropdown.contains(event.target)) {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            document.getElementById('dropdownArrow').style.transform = 'rotate(0deg)';
        }
    });
</script>

</body>
</html>
