<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${producto.nombreProducto} + ' - Terranova'">Detalle Producto - AgroMarket</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#388e3c',
                        'secondary': '#ffcf00'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'DM Sans', sans-serif;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            transition: all 0.3s ease;
        }

        .gradient-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(5, 150, 105, 0.3);
        }

        #map {
            height: 400px;
            border-radius: 1rem;
            z-index: 1;
        }

        .carousel-container {
            position: relative;
            overflow: hidden;
            border-radius: 1.5rem;
        }

        .carousel-image {
            width: 100%;
            height: 500px;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .carousel-image:hover {
            transform: scale(1.05);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* Mejorado el estilo de las tarjetas de citas */
        .cita-card {
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .cita-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(5, 150, 105, 0.15);
            border-color: rgba(5, 150, 105, 0.2);
        }

        .feature-card {
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            transform: scale(1.02);
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .carousel-nav:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .carousel-nav.prev {
            left: 20px;
        }

        .carousel-nav.next {
            right: 20px;
        }

        html {
            scroll-behavior: smooth;
        }

        /* Añadido estilo para badges de estado */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .status-badge.activa {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .status-badge.inscrito {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
        }

        .status-badge.espera {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
        }

        .status-badge.agotado {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50">


<div th:if="${usuario == null}">
    <nav class="fixed top-0 w-full gradient-bg backdrop-blur-md shadow-lg z-50">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <a class="text-white text-2xl font-bold flex items-center" href="/">
                    <i class='fas fa-leaf mr-2'></i>Terranova
                </a>
                <div class="hidden md:flex items-center space-x-6">
                    <a class="text-white/90 hover:text-white font-medium transition-all duration-300 hover:-translate-y-0.5" href="/">Inicio</a>
                    <a class="text-white/90 hover:text-white font-medium transition-all duration-300 hover:-translate-y-0.5" th:href="@{/productos}">Productos</a>
                    <a class="text-white/90 hover:text-white font-medium transition-all duration-300 hover:-translate-y-0.5" href="#servicios">Servicios</a>
                    <a class="text-white/90 hover:text-white font-medium transition-all duration-300 hover:-translate-y-0.5" href="#contacto">Contacto</a>
                </div>
                <button th:if="${usuario == null}" onclick="abrirModalInicio()" class="bg-white/20 border-2 border-white/30 text-white px-6 py-2 rounded-full font-semibold transition-all duration-300 hover:bg-white hover:text-primary-emerald hover:-translate-y-0.5 backdrop-blur-md">
                    <i class='bx bx-user mr-2'></i>Iniciar Sesión
                </button>
            </div>
        </div>
    </nav>
    <div class="pt-16"></div>
</div>

<div th:if="${usuario != null}">
    <div th:replace="fragments/comprador/navbarComprador :: navbarComprador"></div>
</div>

<!-- Mejorada la estructura del contenedor principal -->
<div th:classappend="${usuario == null} ? 'max-w-7xl px-8' : 'ml-80 flex flex-col min-h-screen'" class="container mx-auto py-8">

    <div th:if="${usuario != null}">
        <nav class="mb-6 fade-in-up">
            <ol class="flex items-center space-x-2 text-sm">
                <li><a th:href="@{/comprador/explorar}" class="text-primary hover:text-green-700 transition-colors font-medium">Productos</a></li>
                <li><i class='bx bx-chevron-right text-gray-400'></i></li>
                <li class="text-gray-600 font-medium" th:text="${producto.nombreProducto}">Producto</li>
            </ol>
        </nav>
    </div>

    <div th:classappend="${usuario == null} ? 'lg:grid-cols-1' : 'lg:grid-cols-4'" class="grid gap-8">

        <!-- Columna principal con mejor organización -->
        <div th:classappend="${usuario == null} ? 'lg:col-span-1' : 'lg:col-span-3'" class="space-y-8">

            <!-- Carrusel de imágenes -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden fade-in-up carousel-container">
                <div class="relative">
                    <div id="carousel" class="relative">
                        <div th:each="imagen, iterStat : ${producto.imagenes}"
                             th:class="${iterStat.index == 0} ? 'carousel-slide active' : 'carousel-slide hidden'">
                            <img th:src="${imagen.nombreArchivo}"
                                 class="carousel-image"
                                 th:alt="${producto.nombreProducto}">
                        </div>
                    </div>

                    <div class="carousel-nav prev" onclick="changeSlide(-1)">
                        <i class='bx bx-chevron-left text-2xl text-gray-700'></i>
                    </div>
                    <div class="carousel-nav next" onclick="changeSlide(1)">
                        <i class='bx bx-chevron-right text-2xl text-gray-700'></i>
                    </div>

                    <div class="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-10">
                        <span th:each="imagen, iterStat : ${producto.imagenes}"
                              th:onclick="'goToSlide(' + ${iterStat.index} + ')'"
                              th:class="${iterStat.index == 0} ? 'carousel-indicator active' : 'carousel-indicator'"
                              class="w-3 h-3 rounded-full bg-white bg-opacity-50 cursor-pointer transition-all hover:bg-opacity-100">
                        </span>
                    </div>
                </div>
            </div>

            <!-- Información principal del producto reorganizada -->
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in-up">
                <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6 mb-6">
                    <div class="flex-1">
                        <h1 class="text-4xl font-bold text-gray-900 mb-4" th:text="${producto.nombreProducto}">Nombre del Producto</h1>
                        <div class="flex flex-wrap items-center gap-4 mb-4">
                            <span class="status-badge activa">
                                <i class='bx bx-check-circle text-lg'></i>
                                <span th:text="${producto.estado}">Disponible</span>
                            </span>
                            <span class="flex items-center gap-2 text-gray-600">
                                <i class='bx bx-map text-primary text-xl'></i>
                                <span class="font-medium" th:text="${producto.ciudad.nombreCiudad}">Ciudad</span>
                            </span>
                            <span class="flex items-center gap-2 text-gray-500 text-sm">
                                <i class='bx bx-calendar'></i>
                                <span th:text="${#temporals.format(producto.fechaPublicacion, 'dd/MM/yyyy')}">01/01/2024</span>
                            </span>
                        </div>
                    </div>
                    <div class="text-left lg:text-right bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-2xl border-2 border-green-100">
                        <p class="text-sm text-gray-600 mb-2 font-medium">Precio</p>
                        <p class="text-5xl font-bold gradient-bg bg-clip-text text-transparent">
                            $<span th:text="${#numbers.formatInteger(producto.precioProducto, 0, 'COMMA')}">0</span>
                        </p>
                    </div>
                </div>

                <div class="border-t border-gray-200 pt-6">
                    <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                        <i class='bx bx-info-circle text-primary text-2xl'></i>
                        Descripción
                    </h3>
                    <p class="text-gray-600 leading-relaxed text-lg" th:text="${producto.descripcion}">Descripción del producto</p>
                </div>
            </div>

            <!-- Características -->
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in-up">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <i class='bx bx-list-ul text-primary text-2xl'></i>
                    Características Detalladas
                </h3>

                <div th:if="${producto.tipoP == 'Terreno'}" class="grid md:grid-cols-2 gap-4">
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-ruler text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tamaño del Terreno</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.tamanoTerreno} + ' m²'">0 m²</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-layer text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tipo de Terreno</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.tipoTerreno}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-trending-up text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Topografía</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.topografiaTerreno}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-car text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Acceso</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.acceso}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-wrench text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Servicios</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.servicios}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-leaf text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Uso Actual</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.usoActual}">-</p>
                        </div>
                    </div>
                </div>

                <div th:if="${producto.tipoP == 'Ganado'}" class="grid md:grid-cols-2 gap-4">
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-dna text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Raza</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.razaGanado}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-trending-up text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Peso</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.pesoGanado} + ' kg'">0 kg</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-calendar text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Edad</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.edadGanado} + ' años'">0 años</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-male-female text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Género</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.generoGanado}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-category text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tipo de Ganado</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.tipoGanado}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-hash text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Cantidad</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.cantidad} + ' cabezas'">0 cabezas</p>
                        </div>
                    </div>
                </div>

                <div th:if="${producto.tipoP == 'Finca'}" class="grid md:grid-cols-2 gap-4">
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-expand text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Espacio Total</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.espacioTotal}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-home text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Espacio Construido</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.espacioConstruido}">-</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-layer text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Estrato</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.estratoFinca}">0</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-bed text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Habitaciones</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.numeroHabitaciones}">0</p>
                        </div>
                    </div>
                    <div class="feature-card flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-14 h-14 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                            <i class='bx bx-bath text-white text-2xl'></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Baños</p>
                            <p class="text-xl font-bold text-gray-900" th:text="${producto.numeroBanos}">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección de citas completamente rediseñada -->
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in-up">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-8">
                    <div>
                        <h2 class="text-3xl font-bold text-gray-900 mb-2 flex items-center gap-3">
                            <i class='bx bx-calendar-event text-primary text-4xl'></i>
                            Citas Disponibles
                        </h2>
                        <p class="text-gray-600">Selecciona una fecha y hora para agendar tu visita</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl px-6 py-4 border-2 border-green-100">
                        <div class="flex items-center gap-3">
                            <i class='bx bx-calendar-check text-primary text-3xl'></i>
                            <div>
                                <p class="text-sm text-gray-600 font-medium">Total de citas</p>
                                <p class="text-3xl font-bold text-green-600" th:text="${citasDisponibles.size()}">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div th:if="${#lists.isEmpty(citasDisponibles)}" class="text-center py-16">
                    <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i class='bx bx-calendar-x text-gray-400 text-6xl'></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">No hay citas disponibles</h3>
                    <p class="text-gray-600 max-w-md mx-auto">Este producto no tiene citas programadas en este momento. Vuelve más tarde para ver nuevas disponibilidades.</p>
                </div>

                <!-- Grid de citas -->
                <div th:if="${!#lists.isEmpty(producto.citas)}" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div th:each="cita : ${citasDisponibles}" class="cita-card bg-gradient-to-br from-white to-gray-50 rounded-2xl overflow-hidden">
                        <div class="p-6">
                            <!-- Header con fecha y estado -->
                            <div class="flex items-start justify-between mb-5">
                                <div class="flex items-center gap-4 flex-1">
                                    <div class="w-16 h-16 gradient-bg rounded-2xl flex flex-col items-center justify-center text-white flex-shrink-0 shadow-lg">
                                        <span class="text-2xl font-bold" th:text="${#temporals.format(cita.fecha, 'dd')}">01</span>
                                        <span class="text-xs uppercase" th:text="${#temporals.format(cita.fecha, 'MMM')}">Ene</span>
                                    </div>
                                    <div class="flex-1">
                                        <h3 class="text-lg font-bold text-gray-900 mb-1" th:text="${#temporals.format(cita.fecha, 'EEEE')}">Lunes</h3>
                                        <p class="text-gray-600 flex items-center gap-2 text-sm">
                                            <i class='bx bx-time-five text-primary'></i>
                                            <span class="font-semibold" th:text="${#temporals.format(cita.horaInicio, 'HH:mm')} + ' - ' + ${#temporals.format(cita.horaFin, 'HH:mm')}">09:00 - 11:00</span>
                                        </p>
                                    </div>
                                </div>
                                <span th:if="${cita.estadoCita.name() == 'ACTIVA'}" class="status-badge activa flex-shrink-0">
                                    <i class='bx bx-check-circle'></i>
                                    Activa
                                </span>
                            </div>

                            <!-- Descripción -->
                            <div th:if="${cita.descripcion != null and !#strings.isEmpty(cita.descripcion)}" class="mb-5 p-4 bg-white rounded-xl border border-gray-100">
                                <p class="text-gray-700 text-sm leading-relaxed" th:text="${cita.descripcion}">Descripción de la cita</p>
                            </div>

                            <!-- Barra de progreso de cupos -->
                            <div class="mb-5">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                        <i class='bx bx-group text-primary'></i>
                                        Disponibilidad
                                    </span>
                                    <span class="text-sm font-bold px-3 py-1 rounded-full"
                                          th:classappend="${cita.disponibles > 0} ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                                        <span th:text="${cita.ocupados}"></span> ocupados de <span th:text="${cita.cupoMaximo}"></span> disponibles
                                    </span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden shadow-inner">
                                    <div class="h-full rounded-full transition-all duration-500 shadow-sm"
                                         th:classappend="${cita.disponibles > 0} ? 'bg-gradient-to-r from-green-500 to-emerald-500' : 'bg-gradient-to-r from-red-500 to-orange-500'"
                                         th:style="'width: ' + ${(cita.ocupados * 100.0 / cita.cupoMaximo)} + '%'"></div>
                                </div>
                            </div>

                            <div class="flex gap-3">
                                <div th:if="${usuarioInscrito}" class="flex-1">
                                    <div class="w-full status-badge inscrito justify-center py-3 text-center">
                                        <i class='bx bxs-check-circle text-xl'></i>
                                        <span class="font-bold">Ya Inscrito</span>
                                    </div>
                                </div>

                                <div th:if="${usuarioEnEspera}" class="flex-1">
                                    <div class="w-full status-badge espera justify-center py-3 text-center">
                                        <i class='bx bx-time text-xl'></i>
                                        <span class="font-bold">En Lista de Espera</span>
                                    </div>
                                </div>

                                <form th:if="${!usuarioInscrito and !usuarioEnEspera and cita.disponibles > 0}"
                                      th:action="@{/comprador/citas/inscribirse/{id}(id=${cita.idCita})}"
                                      method="post"
                                      class="flex-1">
                                    <input type="hidden" name="estado" value="INSCRITO">
                                    <button type="submit" class="w-full gradient-btn text-white font-bold py-3 rounded-xl hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2">
                                        <i class='bx bx-calendar-check text-xl'></i>
                                        Inscribirme Ahora
                                    </button>
                                </form>

                                <form th:if="${!usuarioInscrito and !usuarioEnEspera and cita.disponibles == 0}"
                                      th:action="@{/comprador/citas/inscribirse/{id}(id=${cita.idCita})}"
                                      method="post"
                                      class="flex-1">
                                    <input type="hidden" name="estado" value="EN_ESPERA">
                                    <button type="submit" class="w-full bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold py-3 rounded-xl hover:shadow-xl transition-all duration-300 flex items-center justify-center gap-2">
                                        <i class='bx bx-list-ul text-xl'></i>
                                        Unirme a Lista de Espera
                                    </button>
                                </form>

                                <!-- Botón de detalle -->
                                <a th:href="@{'/comprador/citas/detalle/' + ${cita.idCita}}"
                                   class="bg-white border-2 border-gray-200 text-gray-700 font-bold py-3 px-6 rounded-xl hover:border-primary hover:bg-gray-50 transition-all duration-300 flex items-center justify-center gap-2 shadow-sm">
                                    <i class='bx bx-info-circle text-xl'></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mapa de ubicación -->
            <div class="bg-white rounded-2xl shadow-lg p-8 fade-in-up">
                <h3 class="text-2xl font-bold text-gray-900 mb-6 flex items-center gap-2">
                    <i class='bx bx-map text-primary text-3xl'></i>
                    Ubicación del Producto
                </h3>
                <div id="map" class="w-full h-96 rounded-xl shadow-lg"></div>
                <div class="flex items-center gap-4 bg-gradient-to-r from-gray-50 to-green-50 p-5 rounded-xl mt-6 border border-gray-100">
                    <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center flex-shrink-0">
                        <i class='bx bx-current-location text-white text-2xl'></i>
                    </div>
                    <div>
                        <p class="text-sm text-gray-600 font-medium">Ubicado en</p>
                        <p class="font-bold text-gray-900 text-xl" th:text="${producto.ciudad.nombreCiudad}">Ciudad</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- Sidebar mejorado -->
        <div th:if="${usuario != null}" class="space-y-6">
            <div class="sticky top-4 space-y-6">
                <!-- Card del vendedor -->
                <div class="bg-white rounded-2xl shadow-lg p-6 fade-in-up">
                    <div class="flex items-center gap-2 mb-6">
                        <i class='bx bxs-badge-check text-primary text-3xl'></i>
                        <h3 class="text-xl font-bold text-gray-900">Vendedor</h3>
                    </div>

                    <div class="flex items-center gap-4 mb-6 p-4 bg-gradient-to-br from-gray-50 to-green-50 rounded-xl border border-green-100">
                        <div class="w-16 h-16 gradient-bg rounded-full flex items-center justify-center text-white text-2xl font-bold flex-shrink-0 shadow-lg">
                            <span th:text="${#strings.substring(producto.vendedor.nombres, 0, 1)}">V</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-900 text-lg" th:text="${producto.vendedor.nombres + ' ' + producto.vendedor.apellidos}">Nombre Vendedor</h4>
                            <p class="text-sm text-green-600 font-semibold flex items-center gap-1">
                                <i class='bx bx-badge-check'></i>
                                Verificado
                            </p>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                        <div class="flex items-center gap-3 text-gray-700 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                            <i class='bx bx-envelope text-primary text-xl'></i>
                            <span class="text-sm font-medium" th:text="${producto.vendedor.email}">email@example.com</span>
                        </div>
                        <div class="flex items-center gap-3 text-gray-700 p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors">
                            <i class='bx bx-phone text-primary text-xl'></i>
                            <span class="text-sm font-medium" th:text="'+57 ' + ${producto.vendedor.telefono}">+57 123 456 7890</span>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <!-- Botón de favoritos -->
                        <form th:if="${favoritosIds != null and !#lists.contains(favoritosIds, producto.idProducto.longValue())}"
                              th:action="@{'/comprador/agregarF/' + ${producto.idProducto}}" method="post">
                            <input type="hidden" name="vieneDe" value="detalle">
                            <button class="w-full gradient-btn text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg">
                                <i class='bx bx-heart text-xl'></i>
                                Guardar en Favoritos
                            </button>
                        </form>

                        <form th:if="${favoritosIds != null and #lists.contains(favoritosIds, producto.idProducto.longValue())}"
                              th:action="@{'/comprador/favoritos/eliminar/' + ${producto.idProducto}}" method="post">
                            <input type="hidden" name="vieneDe" value="detalle">
                            <button class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg hover:shadow-xl transition-all">
                                <i class='bx bxs-heart text-xl'></i>
                                Guardado en Favoritos
                            </button>
                        </form>

                        <!-- Botón de compartir -->
                        <button onclick="compartir()" class="w-full bg-gray-100 text-gray-700 font-bold py-4 rounded-xl transition-all duration-300 hover:bg-gray-200 hover:shadow-md flex items-center justify-center gap-2">
                            <i class='bx bx-share-alt text-xl'></i>
                            Compartir Producto
                        </button>
                    </div>
                </div>

                <!-- Card de citas (si ya tiene una) -->
                <div th:if="${yaTieneCita}" class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl shadow-lg p-6 border-2 border-green-200">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class='bx bxs-badge-check text-green-500 text-5xl'></i>
                        </div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">¡Cita Agendada!</h4>
                        <p class="text-gray-700 text-sm mb-5">Ya tienes una cita programada para este producto</p>
                        <a href="/comprador/citas" class="inline-flex items-center justify-center gap-2 gradient-btn text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                            <i class='bx bx-calendar text-xl'></i>
                            Ver Mis Citas
                        </a>
                    </div>
                </div>

                <div th:if="${estaEnListaDeEspera}" class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-2xl shadow-lg p-6 border-2 border-yellow-200">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
                            <i class='bx bx-time-five text-amber-500 text-5xl'></i>
                        </div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">Estás en lista de espera</h4>
                        <p class="text-gray-700 text-sm mb-5">
                            La cita está llena por ahora. Te notificaremos automáticamente si se libera un cupo.
                        </p>

                        <a href="/comprador/citas"
                           class="inline-flex items-center justify-center gap-2 bg-amber-500 hover:bg-amber-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300">
                            <i class='bx bx-calendar text-xl'></i>
                            Ver Mis Citas
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar para usuarios no logueados -->
        <div th:if="${usuario == null}" class="lg:col-span-1">
            <div class="bg-white rounded-2xl shadow-lg p-8 sticky top-24 fade-in-up text-center">
                <div class="mb-6">
                    <div class="w-20 h-20 gradient-bg rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                        <i class='bx bx-lock-open-alt text-white text-4xl'></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">Descubre Más</h3>
                    <p class="text-gray-600 mb-6">Inicia sesión para agendar citas, guardar favoritos y contactar vendedores</p>
                </div>

                <button onclick="abrirModalInicio()" class="w-full gradient-btn text-white font-bold py-4 rounded-xl flex items-center justify-center gap-2 shadow-lg mb-4">
                    <i class='bx bx-user text-xl'></i>
                    Iniciar Sesión
                </button>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-200"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-4 bg-white text-gray-500">¿No tienes cuenta?</span>
                    </div>
                </div>

                <a href="/registro" class="w-full bg-gray-100 text-gray-700 font-bold py-4 rounded-xl flex items-center justify-center gap-2 hover:bg-gray-200 transition-all">
                    <i class='bx bx-user-plus text-xl'></i>
                    Crear Cuenta
                </a>
            </div>
        </div>

    </div>
</div>

<!-- Modal de login -->
<div th:if="${usuario == null}" id="loginModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div id="loginModalContent" class="bg-white rounded-2xl shadow-2xl p-8 text-center transform transition-all duration-300 ease-out max-w-md w-full mx-4 scale-75 opacity-0">
        <div class="mb-6">
            <div class="w-16 h-16 gradient-bg rounded-2xl flex items-center justify-center mx-auto mb-4">
                <i class='bx bx-leaf text-white text-2xl'></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900">Terranova</h1>
        </div>

        <form th:action="@{/login}" method="post" class="space-y-4">
            <div>
                <input type="email" name="username" placeholder="Correo Electrónico" required
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-300" />
            </div>
            <div>
                <input type="password" name="password" placeholder="Contraseña" required
                       class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl outline-none focus:border-primary focus:ring-2 focus:ring-primary/20 transition-all duration-300" />
            </div>
            <div class="text-right">
                <a th:href="@{/password-olvidada}" class="text-sm text-primary hover:text-green-700 transition-colors">
                    ¿Olvidaste tu contraseña?
                </a>
            </div>
            <button type="submit" class="w-full gradient-bg text-white font-semibold py-3 rounded-xl transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5">
                Iniciar Sesión
            </button>
        </form>

        <div class="flex flex-col gap-3 mt-6">
            <a th:href="@{/registro}" class="block w-full bg-gray-100 text-gray-700 hover:bg-gray-200 font-semibold py-3 rounded-xl transition-all duration-300">
                Regístrate
            </a>
            <button onclick="cerrarModalInicio()" class="w-full border-2 border-red-200 text-red-600 hover:bg-red-50 font-semibold py-3 rounded-xl transition-all duration-300">
                Cancelar
            </button>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script th:inline="javascript">

    document.addEventListener('DOMContentLoaded', function() {
        const latitud = /*[[${producto.latitud}]]*/ 0;
        const longitud = /*[[${producto.longitud}]]*/ 0;

        if (!latitud || !longitud || latitud === 0 || longitud === 0) {
            console.error('[v0] Coordenadas inválidas o no disponibles');
            document.getElementById('map').innerHTML =
                '<div class="flex items-center justify-center h-full bg-gray-100 rounded-xl">' +
                '<div class="text-center">' +
                '<i class="bx bx-map-pin text-gray-400 text-6xl mb-4"></i>' +
                '<p class="text-gray-500 font-medium">Ubicación no disponible</p>' +
                '</div></div>';
            return;
        }

        try {
            const map = L.map('map').setView([latitud, longitud], 15);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            const marker = L.marker([latitud, longitud]).addTo(map);
            marker.bindPopup('<b>Ubicación del producto</b><br>' +
                'Lat: ' + latitud.toFixed(6) + '<br>' +
                'Lng: ' + longitud.toFixed(6))
                .openPopup();

            setTimeout(function() {
                map.invalidateSize();
                console.log('[v0] Mapa inicializado correctamente');
            }, 100);

        } catch (error) {
            console.error('[v0] Error al inicializar el mapa:', error);
        }
    });


    let currentSlide = 0;
    const slides = document.querySelectorAll('.carousel-slide');
    const indicators = document.querySelectorAll('.carousel-indicator');

    function showSlide(index) {
        slides.forEach((slide, i) => {
            if (i === index) {
                slide.classList.remove('hidden');
                slide.classList.add('active');
            } else {
                slide.classList.add('hidden');
                slide.classList.remove('active');
            }
        });

        indicators.forEach((indicator, i) => {
            if (i === index) {
                indicator.classList.add('active', 'bg-opacity-100');
            } else {
                indicator.classList.remove('active', 'bg-opacity-100');
            }
        });
    }

    function changeSlide(direction) {
        currentSlide += direction;
        if (currentSlide < 0) currentSlide = slides.length - 1;
        if (currentSlide >= slides.length) currentSlide = 0;
        showSlide(currentSlide);
    }

    function goToSlide(index) {
        currentSlide = index;
        showSlide(currentSlide);
    }

    setInterval(() => {
        changeSlide(1);
    }, 5000);

    function compartir() {
        if (navigator.share) {
            navigator.share({
                title: document.title,
                url: window.location.href
            }).catch(err => console.log('Error sharing:', err));
        } else {
            navigator.clipboard.writeText(window.location.href);
            alert('Enlace copiado al portapapeles');
        }
    }

    function abrirModalInicio() {
        const modal = document.getElementById('loginModal');
        const modalContent = document.getElementById('loginModalContent');
        modal.classList.remove('hidden');
        requestAnimationFrame(() => {
            modalContent.classList.remove('scale-75', 'opacity-0');
            modalContent.classList.add('scale-100', 'opacity-100');
        });
        document.body.style.overflow = 'hidden';
    }

    function cerrarModalInicio() {
        const modal = document.getElementById('loginModal');
        const modalContent = document.getElementById('loginModalContent');
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-75', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }, 300);
    }

    function toggleUserDropdown() {
        const dropdown = document.getElementById('userDropdown');
        const arrow = document.getElementById('dropdownArrow');

        if (dropdown && dropdown.classList.contains('opacity-0')) {
            dropdown.classList.remove('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.add('opacity-100', 'visible', 'scale-100');
            if (arrow) arrow.style.transform = 'rotate(180deg)';
        } else if (dropdown) {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            if (arrow) arrow.style.transform = 'rotate(0deg)';
        }
    }

    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('userDropdown');
        const userButton = event.target.closest('[onclick="toggleUserDropdown()"]');

        if (dropdown && !userButton && !dropdown.contains(event.target)) {
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            const arrow = document.getElementById('dropdownArrow');
            if (arrow) arrow.style.transform = 'rotate(0deg)';
        }
    });

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            cerrarModalInicio();
        }
    });

    document.getElementById('loginModal')?.addEventListener('click', (e) => {
        if (e.target.id === 'loginModal') {
            cerrarModalInicio();
        }
    });
</script>
</body>
</html>
